<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>হোম পেজ - আর্নিং অ্যাপ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #2196F3; /* Blue */
            --danger-color: #f44336; /* Red */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 420px; /* Mobile width */
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #43a047;
        }
        .btn-check {
            background-color: var(--secondary-color);
            transition: background-color 0.2s;
        }
        .btn-check:hover:not(:disabled) {
            background-color: #1e88e5;
        }
        .btn-disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        .pulse-animation {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Custom Modal Styling */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 10px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
    </style>
</head>
<body class="p-4">

    <div class="container">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">স্বাগতম, আপনার আর্নিং ড্যাশবোর্ড</h1>
            <p id="userIdDisplay" class="text-xs text-gray-500 mt-1">ইউজার আইডি: লোড হচ্ছে...</p>
        </header>

        <!-- Balance Card -->
        <div class="card bg-green-500/10 border-l-4 border-green-600">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">আপনার বর্তমান ব্যালেন্স</h2>
            <p class="text-4xl font-extrabold text-green-600 flex items-center">
                <span id="balanceDisplay">০.০০</span> <span class="text-xl ml-2">টাকা</span>
            </p>
        </div>

        <!-- IMPORTANT NOTICE (Separated and Improved) -->
        <div id="importantNotice" class="card bg-yellow-500/10 border-l-4 border-yellow-600">
            <h2 class="text-xl font-bold text-yellow-800 mb-2 flex items-center">
                <!-- Icon for Notice -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-yellow-600" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                গুরুত্বপূর্ণ ঘোষণা: বোনাস পাওয়ার নতুন নিয়মাবলী
            </h2>
            <p class="text-gray-700 text-sm leading-relaxed">
                অনুগ্রহ করে মনে রাখবেন, প্রতিটি সোশ্যাল টাস্কের বোনাস **শুধুমাত্র একবারই** সংগ্রহ করা যাবে। একবার বোনাস নেওয়া হয়ে গেলে, একই টাস্ক বারবার ওপেন করলেও আর কোনো অতিরিক্ত পেমেন্ট যোগ হবে না। চেক বাটনটি তখনই দৃশ্যমান হবে যখন আপনি টাস্ক ওপেন করে অ্যাপে ফিরে আসবেন।
            </p>
        </div>

        <!-- Refer & Earn Box (Separated) -->
        <div id="referEarnBox" class="card bg-blue-500/10 border-l-4 border-blue-600">
            <h2 class="text-xl font-bold text-blue-800 mb-2 flex items-center">
                <!-- Icon for Refer -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.972 5.972 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                </svg>
                রেফার করুন ও উপার্জন করুন
            </h2>
            <p class="text-gray-700 mb-4 text-sm">আপনার বন্ধুদের অ্যাপে আমন্ত্রণ জানান এবং অতিরিক্ত বোনাস লাভ করুন। প্রতিটি সফল রেফারে আপনি পাবেন ১০ টাকা।</p>
            <button class="w-full btn-primary text-white font-semibold py-2 rounded-lg">রেফারেল কোড শেয়ার করুন</button>
        </div>

        <!-- Social Task List -->
        <h2 class="text-xl font-bold text-gray-800 mb-4 mt-6">সোশ্যাল টাস্ক তালিকা</h2>
        <div id="taskList" class="space-y-4">
            <!-- Tasks will be injected here -->
            <p class="text-gray-500 text-center" id="loadingMessage">টাস্ক লোড হচ্ছে...</p>
        </div>
    </div>

    <!-- Custom Modal for Messages (Used instead of alert()) -->
    <div id="messageModal" class="custom-modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">বার্তা</h3>
            <p id="modalBody" class="text-gray-600 mb-4"></p>
            <button onclick="closeModal()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg w-full">বন্ধ করুন</button>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        // --- Firebase Imports (Mandatory) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables Setup (Mandatory) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Mock Config */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentBalance = 0;
        let claimedTasks = {}; // { taskId: true/false }

        // Set log level for debugging
        setLogLevel('Debug');

        // --- App State ---
        const TASKS_DATA = [
            { id: 't001', name: 'ফেসবুক পেজ লাইক দিন', bonus: 5.00, openUrl: 'https://facebook.com/example_page' },
            { id: 't002', name: 'ইউটিউব চ্যানেল সাবস্ক্রাইব করুন', bonus: 10.50, openUrl: 'https://youtube.com/example_channel' },
            { id: 't003', name: 'টেলিগ্রাম গ্রুপে জয়েন করুন', bonus: 7.25, openUrl: 'https://telegram.me/example_group' },
        ];

        // --- Utility Functions ---

        /** Shows a custom modal message. */
        window.showMessage = (title, body) => {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = body;
            document.getElementById('messageModal').classList.remove('hidden');
        };

        /** Closes the custom modal message. */
        window.closeModal = () => {
            document.getElementById('messageModal').classList.add('hidden');
        };

        /** Formats a number to Bengali locale string. */
        const formatCurrency = (amount) => {
             // Using 'bn-BD' for Bangladeshi Taka format
            return parseFloat(amount).toLocaleString('bn-BD', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };


        // --- Firebase Core Setup ---

        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ইউজার আইডি: ${userId}`;
                        isAuthReady = true;
                        // Start listeners after auth is ready
                        setupFirestoreListeners();
                    } else {
                        // Sign in anonymously if no token or user
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loadingMessage').textContent = 'Firebase সংযোগে ত্রুটি হয়েছে।';
            }
        };

        // --- Firestore Listeners ---

        const setupFirestoreListeners = () => {
            // 1. Balance Listener (Public Path: /artifacts/{appId}/public/data/balances/{userId})
            const balanceDocRef = doc(db, `artifacts/${appId}/public/data/balances/${userId}`);
            onSnapshot(balanceDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentBalance = docSnap.data().balance || 0;
                } else {
                    currentBalance = 0;
                }
                document.getElementById('balanceDisplay').textContent = formatCurrency(currentBalance);
                console.log("Balance updated:", currentBalance);
            }, (error) => {
                console.error("Error listening to balance:", error);
            });

            // 2. Claimed Tasks Listener (Private Path: /artifacts/{appId}/users/{userId}/tasks_status/claims)
            const claimsDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks_status/claims`);
            onSnapshot(claimsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    claimedTasks = docSnap.data().tasks || {};
                } else {
                    claimedTasks = {};
                }
                console.log("Claimed tasks updated:", claimedTasks);
                renderTasks();
            }, (error) => {
                console.error("Error listening to claimed tasks:", error);
            });
        };


        // --- Task Rendering and Interaction ---

        const renderTasks = () => {
            const taskListContainer = document.getElementById('taskList');
            taskListContainer.innerHTML = ''; // Clear existing tasks
            document.getElementById('loadingMessage').style.display = 'none';

            TASKS_DATA.forEach(task => {
                const isClaimed = claimedTasks[task.id] === true;
                const statusKey = `task_status_${task.id}`;
                // Get status from session storage to check if user has opened and returned (pending check)
                const isPendingCheck = sessionStorage.getItem(statusKey) === 'pending';

                let buttonText = 'টাস্ক ওপেন করুন';
                let buttonClass = 'btn-primary';
                let buttonAction = `openTask('${task.id}', '${task.openUrl}')`;
                let isDisabled = false;

                if (isClaimed) {
                    buttonText = 'সম্পূর্ণ হয়েছে';
                    buttonClass = 'btn-disabled';
                    buttonAction = '';
                    isDisabled = true;
                } else if (isPendingCheck) {
                    buttonText = 'চেক করুন এবং বোনাস নিন';
                    buttonClass = 'btn-check pulse-animation';
                    buttonAction = `claimBonus('${task.id}', ${task.bonus}, '${statusKey}')`;
                }

                const taskHtml = `
                    <div class="card flex justify-between items-center p-4 bg-white hover:bg-gray-50 transition duration-150">
                        <div>
                            <p class="text-base font-semibold text-gray-800">${task.name}</p>
                            <p class="text-sm text-gray-500">বোনাস: ${formatCurrency(task.bonus)} টাকা</p>
                        </div>
                        <button id="btn_${task.id}"
                            class="text-white font-bold py-2 px-4 rounded-full text-sm shadow-md ${buttonClass}"
                            onclick="${buttonAction}" ${isDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                taskListContainer.insertAdjacentHTML('beforeend', taskHtml);
            });
        };

        // Expose functions globally for HTML onclick
        window.openTask = (taskId, url) => {
            // 1. Check if already claimed. If so, inform the user but allow opening the URL.
            if (claimedTasks[taskId]) {
                showMessage('ইতিমধ্যে সম্পূর্ণ হয়েছে', 'এই টাস্কের বোনাস আপনি আগেই সংগ্রহ করেছেন। আপনি চাইলে আবার লিংকটি ওপেন করতে পারেন।');
            } else {
                // 2. Set status in session storage to pending (simulates task completed/returned)
                sessionStorage.setItem(`task_status_${taskId}`, 'pending');
                showMessage('টাস্ক ওপেন করা হচ্ছে', 'এখন টাস্কটি সম্পূর্ণ করুন। অ্যাপে ফিরে এলে "চেক করুন" বাটনটি দেখতে পাবেন।');
            }

            // 3. Open the URL (The user will open the link, complete the task, and return to the app)
            // Simulating opening external URL in a new tab
            window.open(url, '_blank');

            // 4. Update UI immediately to show the "Check" button for non-claimed tasks
            setTimeout(() => {
                 // Re-render to show the Check button if not claimed
                 if (!claimedTasks[taskId]) {
                    renderTasks();
                 }
            }, 500); // Small delay to ensure session storage update is processed
        };

        window.claimBonus = async (taskId, bonusAmount, statusKey) => {
            if (!isAuthReady || !userId) {
                showMessage('ত্রুটি', 'ব্যবহারকারী তথ্য লোড হয়নি। দয়া করে কিছুক্ষণ অপেক্ষা করুন।');
                return;
            }

            if (claimedTasks[taskId]) {
                showMessage('দুঃখিত', 'এই বোনাসটি একবারই সংগ্রহ করা যায়। আপনি ইতিমধ্যেই এটি সংগ্রহ করেছেন।');
                // Remove pending status if somehow it was set
                sessionStorage.removeItem(statusKey);
                renderTasks();
                return;
            }

            const claimsDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks_status/claims`);
            const balanceDocRef = doc(db, `artifacts/${appId}/public/data/balances/${userId}`);

            try {
                // Use a transaction to ensure both updates (balance and claim status) happen atomically
                await runTransaction(db, async (transaction) => {
                    const claimDocSnap = await transaction.get(claimsDocRef);

                    let currentClaims = {};
                    if (claimDocSnap.exists()) {
                        currentClaims = claimDocSnap.data().tasks || {};
                    }

                    if (currentClaims[taskId] === true) {
                        // Double check in transaction
                        throw new Error("ALREADY_CLAIMED");
                    }

                    // 1. Update Claims
                    currentClaims[taskId] = true;
                    transaction.set(claimsDocRef, { tasks: currentClaims }, { merge: true });

                    // 2. Update Balance (using increment)
                    transaction.set(balanceDocRef, {
                        balance: increment(bonusAmount)
                    }, { merge: true });
                });

                // Success
                showMessage('সফল!', `${formatCurrency(bonusAmount)} টাকা আপনার অ্যাকাউন্টে যোগ করা হয়েছে!`);
                
                // Clear the temporary pending status from session storage
                sessionStorage.removeItem(statusKey);

            } catch (e) {
                if (e.message === "ALREADY_CLAIMED") {
                    showMessage('দুঃখিত', 'এই বোনাসটি একবারই সংগ্রহ করা যায়। আপনি ইতিমধ্যেই এটি সংগ্রহ করেছেন।');
                } else {
                    console.error("Transaction failed:", e);
                    showMessage('ত্রুটি', 'বোনাস যোগ করার সময় সমস্যা হয়েছে। দয়া করে আবার চেষ্টা করুন।');
                }
                // Clear the temporary pending status from session storage on failure
                sessionStorage.removeItem(statusKey);
            }
        };

        // --- Initialize on Load ---
        window.onload = initFirebase;
        window.renderTasks = renderTasks; // Expose globally for initial render or manual trigger if needed

    </script>
</body>
</html>

