<!doctype html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Niva Coin App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <style type="text/tailwindcss">
    body { font-family: 'Inter', sans-serif; } .page { display: none; } .page.active { display: block; } .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #00D27F; width: 40px; height: 40px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:9999; } .hidden { display: none !important; } .payment-method-label { border: 2px solid #4A4A4A; transition: all 0.2s ease-in-out; } .payment-method-radio:checked + .payment-method-label { border-color: #00D27F; background-color: #00D27F20; }
  </style>
  <script id="tailwind-config">tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#00D27F", "background": "#000000", "card-background": "#1A1A1A", "text-primary": "#FFFFFF", "text-secondary": "#A0A0A0", }, fontFamily: { "display": ["Inter", "sans-serif"] } } } }</script>
</head>
<body class="bg-background font-display text-text-primary antialiased">

  <div id="loading-overlay" class="loading-overlay hidden"><div class="loader"></div></div>
  <div id="error-container" class="hidden flex items-center justify-center min-h-screen p-4 text-center"><p>This app can only be used inside Telegram.</p></div>
  
  <div id="app-container" class="relative min-h-screen w-full flex-col hidden">
    <!-- Dashboard -->
    <main id="page-dashboard" class="page flex-1 pb-28">
      <div class="flex items-center p-4"><h2 class="text-xl font-bold flex-1 text-text-secondary">Dashboard</h2><div class="flex size-10 shrink-0 items-center justify-end"><img class="user-profile-pic object-cover rounded-full size-10 border-2 border-primary" src="logo19.jpg" alt="User Avatar"></div></div>
      <h1 id="welcome-message" class="text-3xl font-bold px-4 pb-4 pt-4">Welcome!</h1>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 px-4 py-2">
        <button data-page="page-sell-niva" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-emerald-500 text-white font-bold gap-3 px-4"> <img src="./niva.jpg" class="h-8 w-8 rounded-full" alt="Niva Coin"> <span>Sell Niva</span> </button>
        <button data-page="page-sell-fira" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-amber-500 text-white font-bold gap-3 px-4"> <img src="./fira.jpg" class="h-8 w-8 rounded-full" alt="Fira Coin"> <span>Sell Fira</span> </button>
        <button data-page="page-sell-gmail" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-rose-600 text-white font-bold gap-3 px-4"> <img src="./gmail.jpg" class="h-8 w-8" alt="Gmail"> <span>Sell Gmail</span> </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
        <div><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center"><span class="material-symbols-outlined text-primary text-lg">toll</span></div><p>Niva Coin Sales</p></div><div class="flex items-end justify-between"><div class="flex flex-col"><p id="dashboard-niva-requests" class="text-sm text-text-secondary">...</p><p id="dashboard-niva-total" class="text-sm text-text-secondary">...</p></div><button class="nav-btn-internal flex items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div></div></div>
        <div><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center"><span class="text-primary font-bold text-xl">F</span></div><p>Fira Coin Sales</p></div><div class="flex items-end justify-between"><div class="flex flex-col"><p id="dashboard-fira-requests" class="text-sm text-text-secondary">...</p><p id="dashboard-fira-total" class="text-sm text-text-secondary">...</p></div><button class="nav-btn-internal flex items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div></div></div>
        <div class="col-span-1 md:col-span-2"><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center"><span class="material-symbols-outlined text-primary text-lg">mail</span></div><p>Gmail ID Sales</p></div><div class="flex items-end justify-between"><p id="dashboard-gmail-pending" class="text-sm text-text-secondary">...</p><button class="nav-btn-internal flex items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div></div></div>
        <div class="col-span-1 md:col-span-2"><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex justify-between mb-2"><p>Market Rates</p><p class="text-xs font-bold text-red-500">Live</p></div><div class="flex flex-col gap-1"><p class="text-sm">Fira Coin: <span id="dashboard-fira-rate" class="text-primary font-bold">...</span></p><p class="text-sm">Gmail ID: <span id="dashboard-gmail-rate" class="text-primary font-bold">...</span></p></div></div></div>
      </div>
      <a href="https://t.me/earno_vate_earn" target="_blank" class="fixed bottom-24 right-4 z-50 flex h-14 w-14 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg"><svg class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-1.37.2-1.64l16.43-6.2c.75-.28 1.45.27 1.23 1.22l-2.67 12.3c-.22.99-1.21 1.22-1.87.73l-4.11-3.4-1.98 1.9z"></path></svg></a>
    </main>
    
    <!-- Sell Niva Page -->
    <main id="page-sell-niva" class="page flex-grow p-4 pb-28">
      <header class="flex items-center py-2 justify-between"><button class="nav-btn-internal text-white flex size-10 items-center justify-center -ml-2" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h1 class="text-lg font-bold flex-1 text-center">Sell Your Niva Coin</h1><div class="size-8"></div></header>
      
      <div class="rounded-xl bg-card-background my-4 p-4">
        <h3 class="text-lg font-bold mb-3 text-center">Current Niva Rates</h3>
        <div id="niva-rates-display" class="space-y-2 text-sm"></div>
      </div>

      <form id="sell-niva-form" class="space-y-6">
          <div><label class="block mb-2">Amount to Sell</label><div class="relative"><input id="niva-amount-input" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4 pr-16" placeholder="e.g., 1000" type="number" step="any"/><span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">NIVA</span></div><p id="niva-payout-text" class="text-slate-300 pt-2">You will receive: ~৳0.00</p></div>
          <div><h2 class="text-lg font-bold mb-2">Proof of Transfer</h2><p class="text-sm text-slate-400 mb-4">Upload a screenshot of the completed transaction.</p><div class="relative w-full min-h-[160px] p-6 border-2 border-dashed border-slate-700 rounded-xl bg-card-background"><div id="niva-upload-prompt" class="flex flex-col items-center justify-center text-center cursor-pointer"><span class="material-symbols-outlined text-4xl text-slate-400 mb-2">upload_file</span><p>Attach Screenshot</p></div><div id="niva-preview-container" class="hidden absolute inset-2"><img id="niva-image-preview" src="#" alt="Preview" class="w-full h-full rounded-lg object-cover"><button id="remove-niva-image-btn" type="button" class="absolute top-2 right-2 text-white bg-black/50 flex size-8 items-center justify-center rounded-full"><span class="material-symbols-outlined text-xl">close</span></button></div><input id="niva-file-input" required class="absolute inset-0 opacity-0 cursor-pointer" type="file" accept="image/*"/></div></div>
          <div><h2 class="text-lg font-bold mb-3">Payment Details</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><input type="radio" id="niva-bkash" name="paymentMethodNiva" value="Bkash" class="hidden payment-method-radio" required checked><label for="niva-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./bkash.jpg" class="h-6" alt="Bkash"><span class="font-semibold">Bkash</span></label></div><div><input type="radio" id="niva-nagad" name="paymentMethodNiva" value="Nagad" class="hidden payment-method-radio" required><label for="niva-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./nagad.jpg" class="h-6" alt="Nagad"><span class="font-semibold">Nagad</span></label></div></div><label class="block"><span class="mb-2 block">Payment Number</span><input id="niva-payment-number" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4" placeholder="01XXXXXXXXX" type="tel" pattern="01[0-9]{9}" maxlength="11"/></label></div>
          <button type="submit" class="w-full bg-primary text-background font-bold py-3.5 px-6 rounded-lg !mt-8">Submit Sell Order</button>
      </form>
    </main>

    <!-- Sell Fira Page -->
    <main id="page-sell-fira" class="page flex-grow p-4 pb-28">
      <header class="flex items-center py-2 justify-between"><button class="nav-btn-internal text-white flex size-10 items-center justify-center -ml-2" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h1 class="text-lg font-bold flex-1 text-center">Sell Your Fira Coin</h1><div class="size-8"></div></header>
      <div class="rounded-xl bg-card-background my-4 p-4"><p class="text-lg font-bold">Current Rate: <span id="sell-fira-rate" class="text-primary">...</span></p></div>
      <form id="sell-fira-form" class="space-y-6">
          <div><label class="block mb-2">Amount to Sell</label><div class="relative"><input id="fira-amount-input" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4 pr-16" placeholder="e.g., 1000" type="number" step="any"/><span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">FIRA</span></div><p id="fira-payout-text" class="text-slate-300 pt-2">You will receive: ~৳0.00</p></div>
          <div><h2 class="text-lg font-bold mb-2">Proof of Transfer</h2><p class="text-sm text-slate-400 mb-4">Upload a screenshot of the completed transaction.</p><div class="relative w-full min-h-[160px] p-6 border-2 border-dashed border-slate-700 rounded-xl bg-card-background"><div id="fira-upload-prompt" class="flex flex-col items-center justify-center text-center cursor-pointer"><span class="material-symbols-outlined text-4xl text-slate-400 mb-2">upload_file</span><p>Attach Screenshot</p></div><div id="fira-preview-container" class="hidden absolute inset-2"><img id="fira-image-preview" src="#" alt="Preview" class="w-full h-full rounded-lg object-cover"><button id="remove-fira-image-btn" type="button" class="absolute top-2 right-2 text-white bg-black/50 flex size-8 items-center justify-center rounded-full"><span class="material-symbols-outlined text-xl">close</span></button></div><input id="fira-file-input" required class="absolute inset-0 opacity-0 cursor-pointer" type="file" accept="image/*"/></div></div>
          <div><h2 class="text-lg font-bold mb-3">Payment Details</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><input type="radio" id="fira-bkash" name="paymentMethodFira" value="Bkash" class="hidden payment-method-radio" required checked><label for="fira-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./bkash.jpg" class="h-6" alt="Bkash"><span class="font-semibold">Bkash</span></label></div><div><input type="radio" id="fira-nagad" name="paymentMethodFira" value="Nagad" class="hidden payment-method-radio" required><label for="fira-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./nagad.jpg" class="h-6" alt="Nagad"><span class="font-semibold">Nagad</span></label></div></div><label class="block"><span class="mb-2 block">Payment Number</span><input id="fira-payment-number" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4" placeholder="01XXXXXXXXX" type="tel" pattern="01[0-9]{9}" maxlength="11"/></label></div>
          <button type="submit" class="w-full bg-primary text-background font-bold py-3.5 px-6 rounded-lg !mt-8">Submit Sell Order</button>
      </form>
    </main>

    <!-- Sell Gmail Page -->
    <main id="page-sell-gmail" class="page flex-grow p-4 pb-28">
      <header class="flex items-center py-2 justify-between"><button class="nav-btn-internal text-white flex size-10 items-center justify-center -ml-2" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h2 class="text-lg font-bold flex-1 text-center">Sell Gmail IDs</h2><div class="size-8"></div></header>
      <form id="sell-gmail-form" class="flex flex-col flex-grow space-y-6 mt-4">
          <div><p class="text-gray-300 mb-3">Upload your .xlsx or .csv file.</p><div class="relative flex flex-col items-center justify-center gap-6 rounded-xl border-2 border-dashed border-gray-700 px-6 py-10 cursor-pointer"><div id="gmail-upload-prompt"><span class="material-symbols-outlined text-5xl text-gray-400 mx-auto">cloud_upload</span><p class="font-bold text-center">Tap to select a file</p></div><input id="gmail-file-input" required type="file" accept=".xlsx,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="absolute inset-0 opacity-0 cursor-pointer"/></div><div id="gmail-file-display" class="hidden items-center gap-4 rounded-xl border border-gray-700 bg-card-background p-4 mt-4"><div class="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/20 text-primary shrink-0"><span class="material-symbols-outlined text-2xl">description</span></div><div class="flex-1 min-w-0"><p id="gmail-file-name" class="font-medium break-words"></p><p id="gmail-file-size" class="text-sm text-gray-400"></p></div><button id="remove-gmail-file-btn" type="button" class="text-gray-400 flex size-10 items-center justify-center rounded-full shrink-0"><span class="material-symbols-outlined text-2xl">close</span></button></div></div>
          <div><h2 class="text-lg font-bold mb-3">Payment Details</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><input type="radio" id="gmail-bkash" name="paymentMethodGmail" value="Bkash" class="hidden payment-method-radio" required checked><label for="gmail-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./bkash.jpg" class="h-6" alt="Bkash"><span>Bkash</span></label></div><div><input type="radio" id="gmail-nagad" name="paymentMethodGmail" value="Nagad" class="hidden payment-method-radio" required><label for="gmail-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./nagad.jpg" class="h-6" alt="Nagad"><span>Nagad</span></label></div></div><label><span class="mb-2 block">Payment Number</span><input id="gmail-payment-number" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4" placeholder="01XXXXXXXXX" type="tel" pattern="01[0-9]{9}" maxlength="11"/></label></div>
          <div class="flex-grow"></div><div class="pt-4"><button type="submit" class="w-full h-12 bg-primary text-background font-bold rounded-xl">Submit Request</button></div>
      </form>
    </main>

    <!-- History & Profile Pages -->
    <main id="page-history" class="page flex-1 pb-28"><header class="py-4 px-4"><h1 class="text-lg font-bold text-center">My Sell Requests</h1></header><div id="history-list-container" class="px-4 pt-2 space-y-3"><div class="text-center text-text-secondary">Loading history...</div></div></main>
    <main id="page-profile" class="page flex-1 p-4 pb-28">
      <h1 class="text-lg font-bold text-center mb-6">Settings</h1>
      <div class="flex flex-col gap-8">
        <section class="flex w-full items-center gap-4 rounded-xl bg-card-background p-4"><div class="shrink-0"><img class="user-profile-pic object-cover rounded-full h-16 w-16 border-2 border-primary" src="logo19.jpg" alt="User Avatar"></div><div class="min-w-0"><p id="profile-name" class="text-lg font-bold truncate">...</p><p id="profile-id" class="text-sm text-text-secondary break-all">...</p></div></section>
        <section><h2 class="px-2 mb-3 text-sm font-semibold uppercase text-text-secondary">Activity Summary</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4">
                    <span class="text-primary text-3xl"><span class="material-symbols-outlined">toll</span></span>
                    <p class="text-xs text-text-secondary">Total Niva Sold</p>
                    <p id="profile-niva-sold" class="text-xl font-bold">0</p>
                </div>
                <div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4">
                    <span id="profile-fira-icon-container" class="text-primary h-8 w-8 flex items-center justify-center"></span>
                    <p class="text-xs text-text-secondary">Total Fira Sold</p>
                    <p id="profile-fira-sold" class="text-xl font-bold">0</p>
                </div>
                <div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4 col-span-2">
                    <span class="material-symbols-outlined text-primary text-3xl">alternate_email</span>
                    <p class="text-xs text-text-secondary">Total Gmail IDs Sold</p>
                    <p id="profile-gmail-sold" class="text-xl font-bold">0</p>
                </div>
            </div>
        </section>
        
        <!-- Admin Panel Section -->
        <section id="admin-panel" class="hidden">
          <h2 class="px-2 mb-3 text-sm font-semibold uppercase text-text-secondary">Admin Panel</h2>
          <div class="bg-card-background rounded-xl p-4 space-y-4">
            <h3 class="font-bold">Update Rates</h3>
            <form id="update-rates-form" class="space-y-3">
              <fieldset class="border border-slate-700 p-3 rounded-lg">
                <legend class="px-2 font-semibold text-primary">Niva Coin Rates (/k)</legend>
                <div class="space-y-3">
                    <div><label for="admin-niva-rate-10k" class="block text-sm mb-1">Up to 10k</label><input id="admin-niva-rate-10k" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required></div>
                    <div><label for="admin-niva-rate-50k" class="block text-sm mb-1">Up to 50k</label><input id="admin-niva-rate-50k" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required></div>
                    <div><label for="admin-niva-rate-100k" class="block text-sm mb-1">Up to 100k</label><input id="admin-niva-rate-100k" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required></div>
                    <div><label for="admin-niva-rate-500k" class="block text-sm mb-1">500k+</label><input id="admin-niva-rate-500k" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required></div>
                </div>
              </fieldset>
              <div><label for="admin-fira-rate" class="block text-sm mb-1">Fira Coin Rate (/k)</label><input id="admin-fira-rate" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required></div>
              <div><label for="admin-gmail-rate" class="block text-sm mb-1">Gmail ID Rate</label><input id="admin-gmail-rate" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required></div>
              <button type="submit" class="w-full bg-primary text-background font-bold py-2.5 px-4 rounded-lg">Update Rates</button>
            </form>
          </div>
          <div class="mt-6"><h3 class="font-bold mb-3 px-2">All Sell Requests</h3><div id="admin-requests-container" class="space-y-3"><p class="text-center text-text-secondary">Loading requests...</p></div></div>
        </section>

        <section class="flex w-full items-center justify-between gap-4 rounded-xl bg-blue-900/50 p-4 border border-blue-700"><div class="flex items-center gap-4"><div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-blue-500 text-white"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-1.37.2-1.64l16.43-6.2c.75-.28 1.45.27 1.23 1.22l-2.67 12.3c-.22.99-1.21 1.22-1.87.73l-4.11-3.4-1.98 1.9z"></path></svg></div><div><p class="font-bold text-white">Join Our Telegram</p><p class="text-sm text-blue-200">For news & updates</p></div></div><a href="https://t.me/earno_vate_earn" target="_blank" class="flex h-10 shrink-0 items-center justify-center rounded-lg bg-blue-600 px-4 text-sm font-bold text-white">Join</a></section>
        <div class="bg-blue-900/50 border border-blue-700 text-blue-300 text-sm rounded-lg p-3 text-center">সেল করার পূর্বে টেলিগ্রামের বিস্তারিত দেখে নিবেন</div>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 h-20 bg-card-background/90 backdrop-blur-sm border-t border-text-secondary/10">
      <div class="grid h-full max-w-lg grid-cols-4 mx-auto">
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5" data-page="page-dashboard" data-nav="dashboard"><span class="material-symbols-outlined text-2xl mb-1">dashboard</span><span class="text-xs">Dashboard</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5" data-page="page-dashboard" data-nav="sell"><span class="material-symbols-outlined text-2xl mb-1">add_circle</span><span class="text-xs">Sell</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5" data-page="page-history" data-nav="history"><span class="material-symbols-outlined text-2xl mb-1">history</span><span class="text-xs">History</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5" data-page="page-profile" data-nav="profile"><span class="material-symbols-outlined text-2xl mb-1">person</span><span class="text-xs">Profile</span></button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const ADMIN_TELEGRAM_ID = '6703675335';
    const $ = (id) => document.getElementById(id);
    const showLoader = () => $('loading-overlay').classList.remove('hidden');
    const hideLoader = () => $('loading-overlay').classList.add('hidden');
    
    let telegramUser;
    let tg; 
    let marketRates = {
        nivaRates: {
            tier1: { upTo: 10000, rate: 7.5 },
            tier2: { upTo: 50000, rate: 8.0 },
            tier3: { upTo: 100000, rate: 8.5 },
            tier4: { upTo: 500000, rate: 9.0 }
        },
        firaRate: 5.0,
        gmailRate: 13
    };

    const firebaseConfig = {
        apiKey: "AIzaSyCAQtTRKgOizQjgqCbIZ_Z357LQD2Woee8",
        authDomain: "earnovate-bot.firebaseapp.com",
        databaseURL: "https://earnovate-bot-default-rtdb.firebaseio.com",
        projectId: "earnovate-bot",
        appId: "1:395184310691:web:9a0a2e5ad0e954b527b216",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function startApp() {
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                telegramUser = tg.initDataUnsafe?.user;
                if (telegramUser?.id) {
                    initializeAppUI();
                } else { throw new Error("Could not get Telegram user data."); }
            } else { $('error-container').classList.remove('hidden'); }
        } catch (error) {
            $('error-container').classList.remove('hidden').innerHTML = `<p>Error: ${error.message}</p>`;
        }
    }
    
    function initializeAppUI() {
        const { id, first_name, photo_url } = telegramUser;
        document.querySelectorAll('.user-profile-pic').forEach(p => p.src = photo_url || 'logo19.jpg');
        $('welcome-message').textContent = `Welcome, ${first_name || 'User'}!`;
        $('profile-name').textContent = first_name || 'User';
        $('profile-id').textContent = `Telegram ID: ${id}`;
        
        $('profile-fira-icon-container').innerHTML = `<div class="flex items-center justify-center h-full w-full bg-amber-500 rounded-full text-white font-bold text-xl leading-none">F</div>`;
        
        if (id.toString() === ADMIN_TELEGRAM_ID) { $('admin-panel').classList.remove('hidden'); }
        
        $('app-container').classList.remove('hidden');
        setupEventListeners();
        loadAndDisplayRates();
        showPage('page-dashboard');
    }

    function setupEventListeners() {
        document.querySelectorAll('.nav-btn, .nav-btn-internal').forEach(btn => {
            btn.addEventListener('click', () => showPage(btn.dataset.page));
        });

        $('niva-amount-input').addEventListener('input', calculateNivaPayout);
        setupImageUpload('niva');
        $('sell-niva-form').addEventListener('submit', (e) => handleCoinSubmit(e, 'niva'));

        $('fira-amount-input').addEventListener('input', () => {
            const amount = parseFloat($('fira-amount-input').value) || 0;
            $('fira-payout-text').textContent = `You will receive: ~৳${(amount / 1000 * marketRates.firaRate).toFixed(2)}`;
        });
        setupImageUpload('fira');
        $('sell-fira-form').addEventListener('submit', (e) => handleCoinSubmit(e, 'fira'));
        
        setupGmailUpload();
        $('sell-gmail-form').addEventListener('submit', handleGmailSubmit);
        
        if (telegramUser.id.toString() === ADMIN_TELEGRAM_ID) {
            $('update-rates-form').addEventListener('submit', handleRateUpdate);
        }
    }

    function calculateNivaPayout() {
        const amount = parseFloat($('niva-amount-input').value) || 0;
        const tiers = Object.values(marketRates.nivaRates).sort((a, b) => a.upTo - b.upTo);
        let selectedRate = tiers[tiers.length - 1].rate; 

        for (const tier of tiers) {
            if (amount <= tier.upTo) {
                selectedRate = tier.rate;
                break;
            }
        }
        const payout = (amount / 1000 * selectedRate).toFixed(2);
        $('niva-payout-text').textContent = `You will receive: ~৳${payout} (Rate: ৳${selectedRate}/k)`;
    }

    async function handleCoinSubmit(e, coinType) {
        e.preventDefault(); showLoader();
        try {
            const file = $(`${coinType}-file-input`).files[0];
            if (!file) throw new Error("Please upload a screenshot.");
            const payload = createPayload($(`sell-${coinType}-form`)[`paymentMethod${coinType.charAt(0).toUpperCase() + coinType.slice(1)}`].value, $(`${coinType}-payment-number`).value);
            payload.type = `${coinType}-coin`;
            payload.amount = parseFloat($(`${coinType}-amount-input`).value);
            payload.proofImageData = await fileToBase64(file);
            await db.ref(`requests/${payload.id}`).set(payload);
            tg.showAlert('Request submitted successfully!');
            e.target.reset();
            $(`remove-${coinType}-image-btn`).click();
            showPage('page-history');
        } catch (err) {
            tg.showAlert(`Submission Failed: ${err.message}`);
        } finally { hideLoader(); }
    }

    async function handleGmailSubmit(e) {
        e.preventDefault(); showLoader();
        try {
            const file = $('gmail-file-input').files[0];
            if (!file) throw new Error("Please upload a file.");
            const payload = createPayload($('sell-gmail-form').paymentMethodGmail.value, $('gmail-payment-number').value);
            payload.type = 'gmail-id';
            payload.fileName = file.name;
            payload.fileData = await fileToBase64(file);
            await db.ref(`requests/${payload.id}`).set(payload);
            tg.showAlert('Request submitted successfully!');
            e.target.reset();
            $('remove-gmail-file-btn').click();
            showPage('page-history');
        } catch (err) {
            tg.showAlert(`Submission Failed: ${err.message}`);
        } finally { hideLoader(); }
    }

    function handleRateUpdate(e) {
        e.preventDefault(); showLoader();
        try {
            const ratesToUpdate = {
                nivaRates: {
                    tier1: { upTo: 10000, rate: parseFloat($('admin-niva-rate-10k').value) },
                    tier2: { upTo: 50000, rate: parseFloat($('admin-niva-rate-50k').value) },
                    tier3: { upTo: 100000, rate: parseFloat($('admin-niva-rate-100k').value) },
                    tier4: { upTo: 500000, rate: parseFloat($('admin-niva-rate-500k').value) }
                },
                firaRate: parseFloat($('admin-fira-rate').value),
                gmailRate: parseFloat($('admin-gmail-rate').value)
            };
            if (Object.values(ratesToUpdate.nivaRates).some(t => isNaN(t.rate)) || isNaN(ratesToUpdate.firaRate) || isNaN(ratesToUpdate.gmailRate)) {
                throw new Error("Invalid rate values.");
            }
            db.ref('rates').set(ratesToUpdate);
            tg.showAlert('Rates updated successfully!');
        } catch (err) {
            tg.showAlert(`Rate update failed: ${err.message}`);
        } finally { hideLoader(); }
    }
    
    function setupImageUpload(prefix) {
        const fileInput = $(`${prefix}-file-input`);
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) { $(`${prefix}-image-preview`).src = URL.createObjectURL(file); $(`${prefix}-upload-prompt`).classList.add('hidden'); $(`${prefix}-preview-container`).classList.remove('hidden'); }
        });
        $(`remove-${prefix}-image-btn`).addEventListener('click', (e) => {
            e.preventDefault(); fileInput.value = null; $(`${prefix}-image-preview`).src = '#'; $(`${prefix}-upload-prompt`).classList.remove('hidden'); $(`${prefix}-preview-container`).classList.add('hidden');
        });
    }
    
    function setupGmailUpload() {
        const gmailFileInput = $('gmail-file-input');
        gmailFileInput.addEventListener('change', () => {
            const file = gmailFileInput.files[0];
            if (file) { $('gmail-file-name').textContent = file.name; $('gmail-file-size').textContent = `${(file.size / 1024).toFixed(2)} KB`; $('gmail-upload-prompt').classList.add('hidden'); $('gmail-file-display').classList.remove('hidden'); }
        });
        $('remove-gmail-file-btn').addEventListener('click', (e) => {
            e.preventDefault(); gmailFileInput.value = null; $('gmail-upload-prompt').classList.remove('hidden'); $('gmail-file-display').classList.add('hidden');
        });
    }

    function createPayload(paymentMethod, paymentNumber) {
        const newRequestRef = db.ref('requests').push();
        return { id: newRequestRef.key, telegramId: telegramUser.id.toString(), userName: telegramUser.first_name || 'User', status: 'Processing', requestDate: new Date().toISOString(), paymentMethod, paymentNumber };
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
    }

    function showPage(pageId) {
        if (!pageId) return;
        document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
        $(pageId)?.classList.add("active");
        let activeNav = 'dashboard';
        if (['page-sell-niva', 'page-sell-fira', 'page-sell-gmail'].includes(pageId)) { activeNav = 'sell'; } 
        else if (pageId === 'page-history') { activeNav = 'history'; } 
        else if (pageId === 'page-profile') { activeNav = 'profile'; }
        document.querySelectorAll(".nav-btn").forEach(btn => {
            const isSellButton = btn.dataset.nav === 'sell' && activeNav === 'sell';
            const isOtherButton = btn.dataset.nav !== 'sell' && btn.dataset.page === pageId;
            btn.classList.toggle("text-primary", isSellButton || isOtherButton);
            btn.classList.toggle("text-text-secondary", !(isSellButton || isOtherButton));
        });
        loadDashboardData();
        loadProfileData();
        if (pageId === "page-history") loadHistoryData();
        if (pageId === "page-profile" && telegramUser.id.toString() === ADMIN_TELEGRAM_ID) loadAdminData();
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function loadAndDisplayRates() {
        db.ref('rates').on('value', (snapshot) => {
            const rates = snapshot.val();
            if (rates) marketRates = rates;
            $('dashboard-fira-rate').textContent = `৳${marketRates.firaRate} /k`;
            $('dashboard-gmail-rate').textContent = `৳${marketRates.gmailRate}`;
            $('sell-fira-rate').textContent = `৳${marketRates.firaRate} /k`;
            const ratesDisplay = $('niva-rates-display');
            ratesDisplay.innerHTML = '';
            const tiers = Object.values(marketRates.nivaRates || {}).sort((a,b) => a.upTo - b.upTo);
            tiers.forEach(tier => {
                ratesDisplay.insertAdjacentHTML('beforeend', `<div class="flex justify-between items-center bg-background p-2 rounded-md"><span class="text-text-secondary">Up to ${tier.upTo.toLocaleString()} Coins</span><span class="text-primary font-bold">৳${tier.rate}/k</span></div>`);
            });
            if (telegramUser.id.toString() === ADMIN_TELEGRAM_ID) {
                $('admin-niva-rate-10k').value = marketRates.nivaRates.tier1.rate;
                $('admin-niva-rate-50k').value = marketRates.nivaRates.tier2.rate;
                $('admin-niva-rate-100k').value = marketRates.nivaRates.tier3.rate;
                $('admin-niva-rate-500k').value = marketRates.nivaRates.tier4.rate;
                $('admin-fira-rate').value = marketRates.firaRate;
                $('admin-gmail-rate').value = marketRates.gmailRate;
            }
        });
    }
    
    // Updated loadHistoryData function
    async function loadHistoryData() {
        const container = $("history-list-container");
        container.innerHTML = '<div class="text-center text-text-secondary">Loading history...</div>';
        try {
            const snapshot = await db.ref('requests').orderByChild('telegramId').equalTo(telegramUser.id.toString()).once('value');
            const data = snapshot.val();
            if (!data) {
                container.innerHTML = '<p class="text-center text-text-secondary">No requests found.</p>';
                return;
            }
            const userRequests = Object.values(data).sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
            container.innerHTML = "";
            userRequests.forEach(req => {
                let iconContent = '';
                let title = '';

                if (req.type === 'niva-coin') {
                    title = `${(req.amount || 0).toLocaleString()} Niva Coin`;
                    iconContent = `<span class="material-symbols-outlined text-primary text-2xl">toll</span>`;
                } else if (req.type === 'fira-coin') {
                    title = `${(req.amount || 0).toLocaleString()} Fira Coin`;
                    iconContent = `<span class="text-primary font-bold text-2xl">F</span>`; // Custom F icon
                } else { // Gmail
                    title = req.fileName || 'Gmail IDs';
                    iconContent = `<span class="material-symbols-outlined text-primary text-2xl">mail</span>`;
                }
                
                const date = new Date(req.requestDate).toLocaleDateString("en-GB");
                let statusColor = req.status === "Completed" ? "green" : req.status === "Rejected" ? "red" : "orange";

                container.insertAdjacentHTML("beforeend", `
                <div class="flex items-center gap-4 bg-card-background p-3 rounded-xl">
                    <div class="flex items-center justify-center rounded-lg bg-primary/20 shrink-0 w-12 h-12">${iconContent}</div>
                    <div class="flex-1 min-w-0"><p class="font-medium truncate">${title}</p><p class="text-zinc-400 text-sm">${date}</p></div>
                    <div class="shrink-0"><div class="rounded-full px-3 py-1 bg-${statusColor}-400/20 text-${statusColor}-400"><p class="text-xs font-semibold">${req.status}</p></div></div>
                </div>`);
            });
        } catch (e) {
            container.innerHTML = '<p class="text-center text-red-400">Could not load history.</p>';
        }
    }

    async function loadDashboardData() { /* ... same as before ... */ }
    async function loadProfileData() { /* ... same as before ... */ }
    function loadAdminData() { /* ... same as before ... */ }
    function updateRequestStatus(id, status) { /* ... same as before ... */ }

    // Paste the unchanged functions here
    async function loadDashboardData() {
        const snapshot = await db.ref('requests').orderByChild('telegramId').equalTo(telegramUser.id.toString()).once('value');
        const data = snapshot.val();
        let nivaRequests = 0, nivaTotal = 0, firaRequests = 0, firaTotal = 0, gmailPending = 0;
        if (data) {
            Object.values(data).forEach(req => {
                if (req.type === "niva-coin") { nivaRequests++; nivaTotal += Number(req.amount || 0); } 
                else if (req.type === "fira-coin") { firaRequests++; firaTotal += Number(req.amount || 0); } 
                else if (req.type === "gmail-id" && req.status === "Processing") { gmailPending++; }
            });
        }
        $("dashboard-niva-requests").textContent = `${nivaRequests} Requests`;
        $("dashboard-niva-total").textContent = `${nivaTotal.toLocaleString()} Coins`;
        $("dashboard-fira-requests").textContent = `${firaRequests} Requests`;
        $("dashboard-fira-total").textContent = `${firaTotal.toLocaleString()} Coins`;
        $("dashboard-gmail-pending").textContent = `${gmailPending} IDs Pending`;
    }
    async function loadProfileData() {
        const snapshot = await db.ref('requests').orderByChild('telegramId').equalTo(telegramUser.id.toString()).once('value');
        const data = snapshot.val();
        let nivaSold = 0, firaSold = 0, gmailSold = 0;
        if (data) {
            Object.values(data).forEach(req => {
                if (req.status === "Completed") {
                    if (req.type === "niva-coin") nivaSold += Number(req.amount || 0);
                    else if (req.type === "fira-coin") firaSold += Number(req.amount || 0);
                    else if (req.type === "gmail-id") gmailSold += 1;
                }
            });
        }
        $("profile-niva-sold").textContent = nivaSold.toLocaleString();
        $("profile-fira-sold").textContent = firaSold.toLocaleString();
        $("profile-gmail-sold").textContent = gmailSold.toLocaleString();
    }
    function loadAdminData() {
        const container = $('admin-requests-container');
        db.ref('requests').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) { container.innerHTML = '<p class="text-center text-text-secondary">No requests found.</p>'; return; }
            const allRequests = Object.values(data).sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));
            container.innerHTML = '';
            allRequests.forEach(request => {
                const date = new Date(request.requestDate).toLocaleString('en-GB');
                let details = '';
                if (request.type === 'niva-coin' || request.type === 'fira-coin') {
                    details = `<b>Amount:</b> ${request.amount} ${request.type.split('-')[0].toUpperCase()}<br><a href="${request.proofImageData}" target="_blank" class="text-primary"><img src="${request.proofImageData}" class="mt-2 rounded-lg max-w-full h-auto" style="max-height: 200px;"></a>`;
                } else {
                    details = `<b>File:</b> <a href="${request.fileData}" download="${request.fileName}" class="text-primary">${request.fileName}</a>`;
                }
                container.insertAdjacentHTML('beforeend', `<div class="bg-background p-3 rounded-lg border border-slate-800"><p class="font-bold">${request.userName} (${request.telegramId})</p><p class="text-xs text-text-secondary">${date}</p><div class="text-sm my-2">${details}</div><p class="text-sm"><b>Payment:</b> ${request.paymentMethod} - ${request.paymentNumber}</p><p class="text-sm"><b>Status:</b> ${request.status}</p>${request.status === 'Processing' ? `<div class="flex gap-2 mt-3"><button class="approve-btn flex-1 bg-green-500/20 text-green-400 text-sm font-bold py-1.5 rounded" data-id="${request.id}">Approve</button><button class="reject-btn flex-1 bg-red-500/20 text-red-400 text-sm font-bold py-1.5 rounded" data-id="${request.id}">Reject</button></div>` : ''}</div>`);
            });
            document.querySelectorAll('.approve-btn').forEach(btn => btn.onclick = () => updateRequestStatus(btn.dataset.id, 'Completed'));
            document.querySelectorAll('.reject-btn').forEach(btn => btn.onclick = () => updateRequestStatus(btn.dataset.id, 'Rejected'));
        });
    }
    function updateRequestStatus(id, status) {
        showLoader();
        db.ref(`requests/${id}/status`).set(status)
            .then(() => tg.showAlert(`Request has been ${status.toLowerCase()}.`))
            .catch(err => tg.showAlert(`Failed to update status: ${err.message}`))
            .finally(() => hideLoader());
    }

    startApp();
});
</script>
</body>
</html>
