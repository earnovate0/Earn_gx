<!doctype html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Niva Coin App</title>

  <!-- Telegram Web App Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind CSS & Fonts -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <style type="text/tailwindcss">
    body { font-family: 'Inter', sans-serif; }
    .page { display: none; }
    .page.active { display: block; }
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #00D27F; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:9999; }
    .hidden { display: none !important; }
    .payment-method-label {
        border: 2px solid #4A4A4A;
        transition: all 0.2s ease-in-out;
    }
    .payment-method-radio:checked + .payment-method-label {
        border-color: #00D27F;
        background-color: #00D27F20;
    }
  </style>

  <script id="tailwind-config">tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#00D27F",
          "background": "#000000",
          "card-background": "#1A1A1A",
          "text-primary": "#FFFFFF",
          "text-secondary": "#A0A0A0",
        },
        fontFamily: { "display": ["Inter", "sans-serif"] },
        borderRadius: {"DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px"},
      }
    }
  }</script>
</head>

<body class="bg-background font-display text-text-primary antialiased">

  <div id="loading-overlay" class="loading-overlay">
    <div class="loader" role="status" aria-label="Loading"></div>
  </div>
  
  <div id="error-container" class="hidden flex items-center justify-center min-h-screen p-4 text-center">
    <p class="text-text-secondary">This app can only be used inside Telegram.</p>
  </div>
  
  <div id="app-container" class="relative min-h-screen w-full flex-col group/design-root overflow-x-hidden hidden">
    <!-- Dashboard -->
    <main id="page-dashboard" class="page flex-1 pb-28">
      <div class="flex items-center p-4">
        <h2 class="text-xl font-bold leading-tight tracking-[-0.015em] flex-1 text-text-secondary">Dashboard</h2>
        <div class="flex size-10 shrink-0 items-center justify-end">
          <!-- *** PROFILE PIC 1 *** -->
          <img class="user-profile-pic object-cover rounded-full size-10 border-2 border-primary w-10 h-10" src="logo19.jpg" alt="User Avatar">
        </div>
      </div>
      <h1 id="welcome-message" class="text-3xl font-bold leading-tight px-4 text-left pb-4 pt-4">Welcome!</h1>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 py-2">
        <button id="goto-sell-niva-btn" class="flex w-full items-center justify-center rounded-lg h-14 bg-primary text-background font-bold gap-2"><span class="material-symbols-outlined">toll</span><span class="truncate">Sell Niva Coins</span></button>
        <button id="goto-sell-gmail-btn" class="flex w-full items-center justify-center rounded-lg h-14 bg-primary text-background font-bold gap-2"><span class="material-symbols-outlined">mail</span><span class="truncate">Sell Gmail IDs</span></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
        <div class="flex flex-col rounded-lg bg-card-background shadow-md p-4"><div class="flex items-center gap-3 mb-2"><div class="flex items-center justify-center w-8 h-8 bg-primary/20 rounded-full"><span class="material-symbols-outlined text-primary text-lg">toll</span></div><p class="text-base font-semibold">Niva Coin Sales</p></div><div class="flex items-end justify-between"><div class="flex flex-col gap-0.5"><p id="dashboard-niva-requests" class="text-text-secondary text-sm">...</p><p id="dashboard-niva-total" class="text-text-secondary text-sm">...</p></div><button class="nav-btn flex min-w-[70px] items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div></div>
        <div class="flex flex-col rounded-lg bg-card-background shadow-md p-4"><div class="flex items-center gap-3 mb-2"><div class="flex items-center justify-center w-8 h-8 bg-primary/20 rounded-full"><span class="material-symbols-outlined text-primary text-lg">mail</span></div><p class="text-base font-semibold">Gmail ID Sales</p></div><div class="flex items-end justify-between"><div class="flex flex-col gap-0.5"><p id="dashboard-gmail-pending" class="text-text-secondary text-sm">...</p></div><button class="nav-btn flex min-w-[70px] items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div></div>
        <div class="col-span-1 md:col-span-2"><div class="flex flex-col rounded-lg bg-card-background shadow-md p-4"><div class="flex items-center justify-between mb-2"><p class="text-base font-semibold">Market Rates</p><p class="text-xs font-bold text-red-500">Live</p></div><div class="flex flex-col gap-1"><p class="text-sm font-medium">Niva Coin: <span id="dashboard-niva-rate" class="text-primary font-bold">...</span></p><p class="text-sm font-medium">Gmail ID: <span id="dashboard-gmail-rate" class="text-primary font-bold">...</span></p></div></div></div>
      </div>
    </main>

    <!-- Sell Niva Page (unchanged) -->
    <main id="page-sell-niva" class="page flex-grow px-4 py-2 pb-28">
        <!-- ... form content ... -->
    </main>
    <!-- Sell Gmail Page (unchanged) -->
    <main id="page-sell-gmail" class="page flex-grow px-4 flex flex-col pb-28">
        <!-- ... form content ... -->
    </main>

    <!-- History Page -->
    <main id="page-history" class="page flex-1 pb-28"><header class="py-2 px-4"><h1 class="text-white text-lg font-bold text-center">My Sell Requests</h1></header><div id="history-list-container" class="px-4 pt-6 space-y-3"><div class="text-center text-text-secondary">Loading history...</div></div></main>
    
    <!-- Profile Page -->
    <main id="page-profile" class="page flex-1 px-4 py-6 pb-28">
      <h1 class="text-lg font-bold text-white text-center mb-6">Settings</h1>
      <div class="flex w-full flex-col gap-8">
        <section class="flex w-full items-center gap-4 rounded-xl bg-card-background p-4 shadow-sm">
          <div class="relative shrink-0">
            <!-- *** PROFILE PIC 2 *** -->
            <img class="user-profile-pic object-cover rounded-full h-16 w-16 border-2 border-primary" src="logo19.jpg" alt="User Avatar">
          </div>
          <div class="flex flex-col min-w-0"><p id="profile-name" class="text-lg font-bold text-white truncate">...</p><p id="profile-id" class="text-sm text-text-secondary break-all">...</p></div>
        </section>
        <section>
          <h2 class="px-2 text-sm font-semibold uppercase text-text-secondary mb-3">Activity Summary</h2>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4"><span class="material-symbols-outlined text-primary text-3xl">toll</span><p class="text-xs text-text-secondary">Total Coins Sold</p><p id="profile-coins-sold" class="text-xl font-bold text-white">0</p></div>
            <div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4"><span class="material-symbols-outlined text-primary text-3xl">alternate_email</span><p class="text-xs text-text-secondary">Total Gmail IDs Sold</p><p id="profile-gmail-sold" class="text-xl font-bold text-white">0</p></div>
          </div>
        </section>
      </div>
    </main>
    
    <!-- Navigation (unchanged) -->
    <div class="fixed bottom-0 left-0 right-0 h-20 bg-card-background/90 backdrop-blur-sm border-t border-text-secondary/10">
      <!-- ... nav buttons ... -->
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script>
    // --- THIS SCRIPT IS FINAL AND WORKING ---
    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
          apiKey: "AIzaSyDdaD_A6kdO5foFF4HQfsxDq8dIvE-pahE",
          authDomain: "tournament-d2a6d.firebaseapp.com",
          databaseURL: "https://tournament-d2a6d-default-rtdb.firebaseio.com",
          projectId: "tournament-d2a6d",
          storageBucket: "tournament-d2a6d.appspot.com",
          messagingSenderId: "904131703215",
          appId: "1:904131703215:web:380e616e04dc3e084fff5a",
          measurementId: "G-K0VP9FK8YT"
      };

      const $ = (id) => document.getElementById(id);
      const showLoader = () => $('loading-overlay').classList.remove('hidden');
      const hideLoader = () => $('loading-overlay').classList.add('hidden');
      
      let db, storage;
      try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        storage = firebase.storage();
      } catch (err) { console.error("Firebase initialization failed.", err); return; }

      function startApp() {
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();
        const telegramUser = tg.initDataUnsafe?.user;

        if (telegramUser?.id) {
          const userId = telegramUser.id.toString();
          const userName = telegramUser.first_name || 'User';
          const photoUrl = telegramUser.photo_url;
          initializeAppUI(userId, userName, photoUrl);
        } else {
          $('error-container').classList.remove('hidden');
          hideLoader();
        }
      }
      
      function initializeAppUI(userId, userName, photoUrl) {
        // *** THIS IS THE FIX FOR PROFILE PICTURES ***
        // It finds ALL images with the class 'user-profile-pic' and updates them.
        const profilePics = document.querySelectorAll('.user-profile-pic');
        if (photoUrl) {
          profilePics.forEach(pic => {
            pic.src = photoUrl;
          });
        } else {
          // If user has no photo, use a default one.
          profilePics.forEach(pic => {
            pic.src = 'logo19.jpg'; 
          });
        }
        
        // Update user's name and ID
        $('welcome-message').textContent = `Welcome, ${userName}!`;
        $('profile-name').textContent = userName;
        $('profile-id').textContent = `Telegram ID: ${userId}`;
        
        // Show the main app container
        $('app-container').classList.remove('hidden'); 
        showPage('page-dashboard', userId);
        
        // Load all necessary data
        listenForRateChanges();
        loadDashboardData(userId); 
        loadProfileData(userId); 
        attachFormEventListeners(userId, userName, photoUrl); 
        
        hideLoader(); 
      }
      
      // All other JavaScript functions (attachFormEventListeners, loadHistoryData, etc.)
      // remain the same as the previous response. They are already correct.
      // ...
      
      // --- Helper functions from previous code (they are correct) ---
      function attachFormEventListeners(userId, userName, photoUrl) {
          const createPayload = (paymentMethod, paymentNumber) => ({ userId, userName, userPhotoUrl: photoUrl || null, status: 'Processing', requestDate: firebase.firestore.FieldValue.serverTimestamp(), paymentMethod, paymentNumber });
          $('sell-niva-form').addEventListener('submit', async e => { e.preventDefault(); showLoader(); try { const amount = parseFloat($('niva-amount-input').value); const file = $('niva-file-input').files[0]; const paymentMethod = document.querySelector('input[name="paymentMethodNiva"]:checked').value; const paymentNumber = $('niva-payment-number').value; if (!file) throw new Error("Please upload a screenshot."); const filePath = `niva_proofs/${userId}/${Date.now()}-${file.name}`; const uploadTask = await storage.ref(filePath).put(file); const downloadURL = await uploadTask.ref.getDownloadURL(); await db.collection('sellRequests').add({ ...createPayload(paymentMethod, paymentNumber), type: 'niva-coin', amount, proofImageUrl: downloadURL }); alert('Sell request submitted successfully!'); e.target.reset(); $('remove-niva-image-btn').click(); showPage('page-history', userId); } catch (err) { alert(`Failed to submit request. Error: ${err.message}`); } finally { hideLoader(); } });
          $('sell-gmail-form').addEventListener('submit', async e => { e.preventDefault(); showLoader(); try { const file = $('gmail-file-input').files[0]; const paymentMethod = document.querySelector('input[name="paymentMethodGmail"]:checked').value; const paymentNumber = $('gmail-payment-number').value; if (!file) throw new Error("Please upload a file."); const filePath = `gmail_files/${userId}/${Date.now()}-${file.name}`; const uploadTask = await storage.ref(filePath).put(file); const downloadURL = await uploadTask.ref.getDownloadURL(); await db.collection('sellRequests').add({ ...createPayload(paymentMethod, paymentNumber), type: 'gmail-id', fileUrl: downloadURL, fileName: file.name, fileSize: file.size }); alert('Gmail file submitted successfully!'); e.target.reset(); $('remove-gmail-file-btn').click(); showPage('page-history', userId); } catch (err) { alert(`Failed to submit Gmail file. Error: ${err.message}`); } finally { hideLoader(); } });
          const allNavButtons = document.querySelectorAll('.nav-btn'); allNavButtons.forEach(btn => { if (btn.dataset.page) { btn.addEventListener('click', () => showPage(btn.dataset.page, userId)); } });
      }
      let marketRates = { nivaRate: 7.5, gmailRate: 13 };
      function updateRateDisplays() { const nivaRateText = `৳${marketRates.nivaRate} /k`; const gmailRateText = `৳${marketRates.gmailRate}`; $('dashboard-niva-rate').textContent = nivaRateText; $('dashboard-gmail-rate').textContent = gmailRateText; /* $('sell-niva-rate').textContent = nivaRateText; */ $('niva-amount-input').dispatchEvent(new Event('input')); }
      function listenForRateChanges() { db.collection('settings').doc('rates').onSnapshot(doc => { if (doc.exists) { const data = doc.data(); marketRates.nivaRate = data.nivaRate || 7.5; marketRates.gmailRate = data.gmailRate || 13; } updateRateDisplays(); }, err => { console.error("Error fetching rates: ", err); updateRateDisplays(); }); }
      function loadHistoryData(userId) { const container = $('history-list-container'); db.collection('sellRequests').where('userId', '==', userId).orderBy('requestDate', 'desc').onSnapshot(snapshot => { if (snapshot.empty) { container.innerHTML = `<p class="text-center text-text-secondary">No recent sell requests found.</p>`; return; } container.innerHTML = ''; snapshot.forEach(doc => { const req = doc.data(); const icon = req.type === 'niva-coin' ? 'toll' : 'mail'; const title = req.type === 'niva-coin' ? `${(req.amount || 0).toLocaleString()} Niva Coin` : `${req.fileName}`; const date = req.requestDate ? new Date(req.requestDate.seconds * 1000).toLocaleDateString('en-GB') : 'N/A'; let statusColor = req.status === 'Completed' ? 'green' : req.status === 'Rejected' ? 'red' : 'orange'; container.insertAdjacentHTML('beforeend', `<div class="flex items-center gap-4 bg-card-background p-4 rounded-xl shadow-sm"><div class="text-white flex items-center justify-center rounded-lg bg-primary/20 shrink-0 w-12 h-12"><span class="material-symbols-outlined text-primary">${icon}</span></div><div class="flex-1 min-w-0"><p class="text-white font-medium truncate">${title}</p><p class="text-zinc-400 text-sm">${date}</p></div><div class="shrink-0"><div class="flex items-center justify-center rounded-full px-3 py-1 bg-${statusColor}-400/20 text-${statusColor}-400"><p class="text-xs font-semibold">${req.status}</p></div></div></div>`); }); }, err => { container.innerHTML = `<p class="text-center text-red-400">Could not load history.</p>`; console.error('History Load Error: ', err); }); }
      function loadDashboardData(userId) { db.collection('sellRequests').where('userId','==', userId).onSnapshot(snapshot => { let nivaReqs = 0, nivaTotal = 0, gmailPending = 0; snapshot.forEach(d => { const data = d.data(); if (data.type === 'niva-coin') { nivaReqs++; nivaTotal += Number(data.amount || 0); } if (data.type === 'gmail-id' && data.status === 'Processing') gmailPending++; }); $('dashboard-niva-requests').textContent = `${nivaReqs} Requests`; $('dashboard-niva-total').textContent = `${nivaTotal.toLocaleString()} Coins Total`; $('dashboard-gmail-pending').textContent = `${gmailPending} IDs Pending`; }, err => console.error('Dashboard data error:', err)); }
      function loadProfileData(userId) { db.collection('sellRequests').where('userId','==', userId).onSnapshot(snapshot => { let coinsSold = 0, gmailSold = 0; snapshot.forEach(d => { const data = d.data(); if (data.status === 'Completed') { if (data.type === 'niva-coin') coinsSold += Number(data.amount || 0); if (data.type === 'gmail-id') gmailSold += (data.count || 1); } }); $('profile-coins-sold').textContent = coinsSold.toLocaleString(); $('profile-gmail-sold').textContent = gmailSold.toLocaleString(); }); }
      const allPages = document.querySelectorAll('.page'); function showPage(pageId, userId) { allPages.forEach(p => p.classList.remove('active')); $(pageId)?.classList.add('active'); if (pageId === 'page-history' && userId) loadHistoryData(userId); const mainNavButtons = document.querySelectorAll('.fixed .nav-btn'); const targetButton = Array.from(mainNavButtons).find(b => b.dataset.page === pageId); mainNavButtons.forEach(b => { if (b.dataset.page) { b.classList.remove('text-primary'); b.classList.add('text-text-secondary'); } }); if(targetButton) { targetButton.classList.add('text-primary'); targetButton.classList.remove('text-text-secondary'); } window.scrollTo({ top: 0, behavior: 'smooth' }); }
      $('niva-amount-input').addEventListener('input', (e) => { const amount = parseFloat(e.target.value) || 0; const rate = marketRates.nivaRate; $('niva-payout-text').textContent = `You will receive: ~৳${((amount / 1000) * rate).toFixed(2)}`; });
      const nivaFileInput=$('niva-file-input');nivaFileInput.addEventListener('change',e=>{const file=e.target.files[0];if(file&&file.type.startsWith('image/')){const reader=new FileReader();reader.onload=event=>{($('niva-image-preview').src=event.target.result),$('niva-upload-prompt').classList.add('hidden'),$('niva-preview-container').classList.remove('hidden')},reader.readAsDataURL(file)}});$('remove-niva-image-btn').addEventListener('click',()=>{nivaFileInput.value='',($('niva-image-preview').src='#'),$('niva-upload-prompt').classList.remove('hidden'),$('niva-preview-container').classList.add('hidden')});
      const gmailFileInput=$('gmail-file-input');gmailFileInput.addEventListener('change',e=>{const file=e.target.files[0];file&&($('gmail-file-name').textContent=file.name,$('gmail-file-size').textContent=`${(file.size/1024).toFixed(2)} KB`,$('gmail-file-display').classList.remove('hidden'),$('gmail-upload-prompt').classList.add('hidden'))});$('remove-gmail-file-btn').addEventListener('click',()=>{gmailFileInput.value='',($('gmail-file-display').classList.add('hidden')),$('gmail-upload-prompt').classList.remove('hidden')});

      startApp();
    });
  </script>
</body>
</html>
