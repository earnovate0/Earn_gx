<!doctype html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Niva Coin App</title>

  <!-- *** STEP 1: ADD TELEGRAM WEB APP SCRIPT *** -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <style type="text/tailwindcss">
    body { font-family: 'Inter', sans-serif; }
    .page { display: none; }
    .page.active { display: block; }
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #00D27F; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:9999; }
    .hidden { display: none !important; }
    .payment-method-label {
        border: 2px solid #4A4A4A;
        transition: all 0.2s ease-in-out;
    }
    .payment-method-radio:checked + .payment-method-label {
        border-color: #00D27F;
        background-color: #00D27F20;
    }
  </style>

  <script id="tailwind-config">tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#00D27F",
          "background": "#000000",
          "card-background": "#1A1A1A",
          "text-primary": "#FFFFFF",
          "text-secondary": "#A0A0A0",
        },
        fontFamily: { "display": ["Inter", "sans-serif"] },
        borderRadius: {"DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px"},
      }
    }
  }</script>
</head>

<body class="bg-background font-display text-text-primary antialiased">

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loader" role="status" aria-label="Loading"></div>
  </div>
  
  <!-- Error Message for non-Telegram users -->
  <div id="error-container" class="hidden flex items-center justify-center min-h-screen p-4 text-center">
    <p class="text-text-secondary">This app can only be used inside Telegram.</p>
  </div>
  
  <!-- APP CONTAINER -->
  <div id="app-container" class="relative min-h-screen w-full flex-col group/design-root overflow-x-hidden hidden">
    <!-- HTML for all pages (Dashboard, Sell Niva, Sell Gmail, etc.) remains the same -->
    <!-- ... Your existing HTML for pages goes here ... -->
        <!-- Dashboard -->
    <main id="page-dashboard" class="page flex-1 pb-28">
      <div class="flex items-center p-4">
        <h2 class="text-xl font-bold leading-tight tracking-[-0.015em] flex-1 text-text-secondary">Dashboard</h2>
        <div class="flex size-10 shrink-0 items-center justify-end">
          <img id="user-avatar" src="logo19.jpg" alt="User Avatar" class="object-cover rounded-full size-10 border-2 border-primary w-10 h-10">
        </div>
      </div>

      <h1 id="welcome-message" class="text-3xl font-bold leading-tight px-4 text-left pb-4 pt-4">Welcome!</h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 py-2">
        <button id="goto-sell-niva-btn" class="flex w-full items-center justify-center rounded-lg h-14 bg-primary text-background font-bold gap-2">
          <span class="material-symbols-outlined">toll</span><span class="truncate">Sell Niva Coins</span>
        </button>
        <button id="goto-sell-gmail-btn" class="flex w-full items-center justify-center rounded-lg h-14 bg-primary text-background font-bold gap-2">
          <span class="material-symbols-outlined">mail</span><span class="truncate">Sell Gmail IDs</span>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
        <div class="flex flex-col rounded-lg bg-card-background shadow-md p-4">
          <div class="flex items-center gap-3 mb-2"><div class="flex items-center justify-center w-8 h-8 bg-primary/20 rounded-full"><span class="material-symbols-outlined text-primary text-lg">toll</span></div><p class="text-base font-semibold">Niva Coin Sales</p></div>
          <div class="flex items-end justify-between"><div class="flex flex-col gap-0.5"><p id="dashboard-niva-requests" class="text-text-secondary text-sm">0 Requests</p><p id="dashboard-niva-total" class="text-text-secondary text-sm">0 Coins Total</p></div><button class="nav-btn flex min-w-[70px] items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div>
        </div>
        <div class="flex flex-col rounded-lg bg-card-background shadow-md p-4">
          <div class="flex items-center gap-3 mb-2"><div class="flex items-center justify-center w-8 h-8 bg-primary/20 rounded-full"><span class="material-symbols-outlined text-primary text-lg">mail</span></div><p class="text-base font-semibold">Gmail ID Sales</p></div>
          <div class="flex items-end justify-between"><div class="flex flex-col gap-0.5"><p id="dashboard-gmail-pending" class="text-text-secondary text-sm">0 IDs Pending</p></div><button class="nav-btn flex min-w-[70px] items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div>
        </div>
        <div class="col-span-1 md:col-span-2">
          <div class="flex flex-col rounded-lg bg-card-background shadow-md p-4">
            <div class="flex items-center justify-between mb-2">
                <p class="text-base font-semibold">Market Rates</p>
                <p class="text-xs font-bold text-red-500">Live</p>
            </div>
            <div class="flex flex-col gap-1">
                <p class="text-sm font-medium">Niva Coin: <span id="dashboard-niva-rate" class="text-primary font-bold">Loading...</span></p>
                <p class="text-sm font-medium">Gmail ID: <span id="dashboard-gmail-rate" class="text-primary font-bold">Loading...</span></p>
            </div>
          </div>
        </div>
      </div>
      
      <a href="https://t.me/earno_vate_earn" target="_blank" rel="noopener noreferrer" class="fixed bottom-24 right-4 z-50 flex h-14 w-14 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg transition-transform hover:scale-110">
        <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.43-6.2c.75-.28 1.45.27 1.23 1.22l-2.67 12.3c-.22.99-1.21 1.22-1.87.73l-4.11-3.4l-1.98 1.9z"></path></svg>
      </a>
    </main>

    <!-- Sell Niva -->
    <main id="page-sell-niva" class="page flex-grow px-4 py-2 pb-28">
      <header class="flex items-center py-2 justify-between"><button class="nav-btn text-white flex size-10 shrink-0 items-center justify-center" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h1 class="text-white text-lg font-bold text-center flex-1">Sell Your Niva Coin</h1><div class="size-10"></div></header>
      <div class="rounded-xl bg-card-background shadow-sm mb-6 mt-4 p-4"><p class="text-white text-lg font-bold">Current Rate: <span id="sell-niva-rate">Loading...</span></p></div>
      <form id="sell-niva-form" class="space-y-6">
        <div>
          <label class="flex flex-col"><p class="text-white text-base font-medium pb-2">Amount to Sell</p><div class="relative"><input id="niva-amount-input" required class="form-input w-full rounded-lg text-white focus:ring-primary/50 border-slate-700 bg-card-background h-14 p-[15px] pr-16" placeholder="e.g., 1000" type="number" step="any"/><span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-medium">NIVA</span></div></label>
          <p id="niva-payout-text" class="text-slate-300 text-base pt-2">You will receive: ~৳0.00</p>
        </div>
        <div>
          <h2 class="text-white text-lg font-bold pb-2">Proof of Transfer</h2><p class="text-slate-400 text-sm pb-4">Upload a screenshot showing the transaction is complete.</p>
          <div id="niva-upload-container" class="relative flex flex-col items-center justify-center w-full min-h-[160px] p-6 border-2 border-dashed border-slate-700 rounded-xl bg-card-background">
            <div id="niva-upload-prompt" class="flex flex-col items-center justify-center text-center cursor-pointer">
                <span class="material-symbols-outlined text-4xl text-slate-400 mb-2">upload_file</span>
                <p class="text-base font-medium text-white">Attach Screenshot</p>
                <p class="text-sm text-slate-400">Click to upload</p>
            </div>
            <div id="niva-preview-container" class="hidden relative w-full">
                <img id="niva-image-preview" src="#" alt="Screenshot Preview" class="w-full h-auto max-h-48 rounded-lg object-cover">
                <button id="remove-niva-image-btn" type="button" class="absolute top-2 right-2 text-white bg-black/50 flex size-8 items-center justify-center rounded-full hover:bg-black/80 transition-colors">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>
            <input id="niva-file-input" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" type="file" accept="image/*"/>
          </div>
        </div>
        <div>
          <h2 class="text-white text-lg font-bold pb-3">Payment Details</h2>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><input type="radio" id="niva-bkash" name="paymentMethodNiva" value="Bkash" class="hidden payment-method-radio" required checked><label for="niva-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="bkash.jpg" class="h-6" alt="Bkash"><span class="text-white font-semibold">Bkash</span></label></div>
            <div><input type="radio" id="niva-nagad" name="paymentMethodNiva" value="Nagad" class="hidden payment-method-radio" required><label for="niva-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="nagad.jpg" class="h-6" alt="Nagad"><span class="text-white font-semibold">Nagad</span></label></div>
          </div>
          <label class="flex flex-col"><p class="text-white text-base font-medium pb-2">Payment Number</p><input id="niva-payment-number" required class="form-input w-full rounded-lg text-white focus:ring-primary/50 border-slate-700 bg-card-background h-14 p-[15px]" placeholder="01XXXXXXXXX" type="tel" pattern="01[0-9]{9}" maxlength="11" title="Number must start with 01 and be 11 digits long."/></label>
        </div>
        <button type="submit" class="w-full bg-primary text-background font-bold text-base py-3.5 px-6 rounded-lg shadow-lg !mt-8">Submit Sell Order</button>
      </form>
    </main>
    
    <main id="page-sell-gmail" class="page flex-grow px-4 flex flex-col pb-28">
      <header class="flex items-center py-2 justify-between"><button class="nav-btn flex size-12 shrink-0 items-center" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl text-white">arrow_back</span></button><h2 class="text-white text-lg font-bold flex-1 text-center">Sell Gmail IDs</h2><div class="w-12"></div></header>
      <form id="sell-gmail-form" class="flex flex-col flex-grow space-y-6 mt-4">
        <div>
          <p class="text-gray-300 text-base pb-3">Upload your Excel file. Ensure it's in .xlsx or .csv format.</p>
          <div class="relative flex flex-col items-center gap-6 rounded-xl border-2 border-dashed border-gray-700 px-6 py-10 cursor-pointer">
            <div id="gmail-upload-prompt">
                <span class="material-symbols-outlined text-5xl text-gray-400 text-center w-full">cloud_upload</span>
                <p id="gmail-upload-text" class="text-white text-lg font-bold text-center">Tap to select a file</p>
                <p class="text-gray-400 text-sm text-center">Only .xlsx and .csv files are accepted</p>
            </div>
            <input id="gmail-file-input" required type="file" accept=".xlsx,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
          </div>
          <div id="gmail-file-display" class="hidden items-center gap-4 rounded-xl border border-gray-700 bg-card-background p-4 mt-4">
            <div class="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/20 text-primary"><span class="material-symbols-outlined text-2xl">description</span></div>
            <div class="flex-1 min-w-0"><p id="gmail-file-name" class="text-white text-base font-medium break-words"></p><p id="gmail-file-size" class="text-gray-400 text-sm"></p></div>
            <button id="remove-gmail-file-btn" type="button" class="text-gray-400 flex size-10 items-center justify-center rounded-full hover:bg-gray-800 shrink-0"><span class="material-symbols-outlined text-2xl">close</span></button>
          </div>
        </div>
        <div>
          <h2 class="text-white text-lg font-bold pb-3">Payment Details</h2>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div><input type="radio" id="gmail-bkash" name="paymentMethodGmail" value="Bkash" class="hidden payment-method-radio" required checked><label for="gmail-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="bkash.jpg" class="h-6" alt="Bkash"><span class="text-white font-semibold">Bkash</span></label></div>
            <div><input type="radio" id="gmail-nagad" name="paymentMethodGmail" value="Nagad" class="hidden payment-method-radio" required><label for="gmail-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="nagad.jpg" class="h-6" alt="Nagad"><span class="text-white font-semibold">Nagad</span></label></div>
          </div>
          <label class="flex flex-col"><p class="text-white text-base font-medium pb-2">Payment Number</p><input id="gmail-payment-number" required class="form-input w-full rounded-lg text-white focus:ring-primary/50 border-slate-700 bg-card-background h-14 p-[15px]" placeholder="01XXXXXXXXX" type="tel" pattern="01[0-9]{9}" maxlength="11" title="Number must start with 01 and be 11 digits long."/></label>
        </div>
        <div class="flex-grow"></div><div class="pb-6 pt-4"><button type="submit" class="w-full h-12 bg-primary text-background font-bold rounded-xl">Submit Request</button></div>
      </form>
    </main>
    <main id="page-history" class="page flex-1 pb-28"><header class="py-2 px-4"><h1 class="text-white text-lg font-bold text-center">My Sell Requests</h1></header><div id="history-list-container" class="px-4 pt-6 space-y-3"></div></main>
    <main id="page-profile" class="page flex-1 px-4 py-6 pb-28">
      <h1 class="text-lg font-bold text-white text-center mb-6">Settings</h1>
      <div class="flex w-full flex-col gap-8">
        <section class="flex w-full items-center gap-4 rounded-xl bg-card-background p-4 shadow-sm">
          <div class="relative shrink-0"><img id="profile-avatar" src="logo19.jpg" alt="User Avatar" class="object-cover rounded-full h-16 w-16 border-2 border-primary"></div>
          <div class="flex flex-col min-w-0"><p id="profile-name" class="text-lg font-bold text-white truncate">Anonymous User</p><p id="profile-id" class="text-sm text-text-secondary break-all"></p></div>
        </section>
        <section>
          <h2 class="px-2 text-sm font-semibold uppercase text-text-secondary mb-3">Activity Summary</h2>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4"><span class="material-symbols-outlined text-primary text-3xl">toll</span><p class="text-xs text-text-secondary">Total Coins Sold</p><p id="profile-coins-sold" class="text-xl font-bold text-white">0</p></div>
            <div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4"><span class="material-symbols-outlined text-primary text-3xl">alternate_email</span><p class="text-xs text-text-secondary">Total Gmail IDs Sold</p><p id="profile-gmail-sold" class="text-xl font-bold text-white">0</p></div>
          </div>
        </section>
        <section class="flex w-full items-center justify-between gap-4 rounded-xl bg-blue-900/50 p-4 border border-blue-700">
            <div class="flex items-center gap-4">
                <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-blue-500 text-white">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.37.2-1.64l16.43-6.2c.75-.28 1.45.27 1.23 1.22l-2.67 12.3c-.22.99-1.21 1.22-1.87.73l-4.11-3.4l-1.98 1.9z"></path></svg>
                </div>
                <div>
                    <p class="font-bold text-white">Join Our Telegram</p>
                    <p class="text-sm text-blue-200">For news & updates</p>
                </div>
            </div>
            <a href="https://t.me/earno_vate_earn" target="_blank" rel="noopener noreferrer" class="flex h-10 shrink-0 items-center justify-center rounded-lg bg-blue-600 px-4 text-sm font-bold text-white hover:bg-blue-700 transition-colors">Join</a>
        </section>
        <div class="bg-blue-900/50 border border-blue-700 text-blue-300 text-sm rounded-lg p-3 text-center">রিকোয়েস্ট সাবমিট করার পূর্বে এডমিনের সঙ্গে যোগাযোগ করে নিবেন।</div>
      </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 h-20 bg-card-background/90 backdrop-blur-sm border-t border-text-secondary/10">
      <div class="grid h-full max-w-lg grid-cols-4 mx-auto font-medium">
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-primary" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl mb-1">dashboard</span><span class="text-xs">Dashboard</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-text-secondary" data-page="page-sell-niva"><span class="material-symbols-outlined text-2xl mb-1">add_circle</span><span class="text-xs">Sell</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-text-secondary" data-page="page-history"><span class="material-symbols-outlined text-2xl mb-1">history</span><span class="text-xs">History</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-text-secondary" data-page="page-profile"><span class="material-symbols-outlined text-2xl mb-1">person</span><span class="text-xs">Profile</span></button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <!-- REMOVED FIREBASE AUTH SCRIPT -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyDdaD_A6kdO5foFF4HQfsxDq8dIvE-pahE",
        authDomain: "tournament-d2a6d.firebaseapp.com",
        databaseURL: "https://tournament-d2a6d-default-rtdb.firebaseio.com",
        projectId: "tournament-d2a6d",
        storageBucket: "tournament-d2a6d.appspot.com",
        messagingSenderId: "904131703215",
        appId: "1:904131703215:web:380e616e04dc3e084fff5a",
        measurementId: "G-K0VP9FK8YT"
      };

      const $ = (id) => document.getElementById(id);
      
      const showLoader = () => $('loading-overlay').classList.remove('hidden');
      const hideLoader = () => $('loading-overlay').classList.add('hidden');
      
      let db, storage;
      try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        storage = firebase.storage();
      } catch (err) { 
        console.error("Firebase initialization failed.", err);
        return; 
      }

      // --- START OF NEW TELEGRAM APP LOGIC ---

      function startApp() {
        const tg = window.Telegram.WebApp;
        tg.ready(); // Let Telegram know the app is ready
        tg.expand(); // Expand the app to full height

        // Get user data from Telegram
        const telegramUser = tg.initDataUnsafe?.user;

        if (telegramUser?.id) {
          // If user exists, initialize the UI with their Telegram ID and name
          const userId = telegramUser.id.toString();
          const userName = telegramUser.first_name || 'User';
          initializeAppUI(userId, userName);
        } else {
          // If not opened in Telegram, show an error and hide loader
          $('error-container').classList.remove('hidden');
          hideLoader();
        }
      }
      
      function initializeAppUI(userId, userName) {
        // Personalize UI
        $('welcome-message').textContent = `Welcome, ${userName}!`;
        $('profile-name').textContent = userName;
        
        $('app-container').classList.remove('hidden'); 
        showPage('page-dashboard'); 
        listenForRateChanges();
        loadDashboardData(userId); 
        loadProfileData(userId); 
        attachFormEventListeners(userId, userName); 
        hideLoader(); 
      }
      
      function loadHistoryData(userId) {
        const container = $('history-list-container');
        // Query using the Telegram user ID
        db.collection('sellRequests').where('userId', '==', userId).orderBy('requestDate', 'desc').onSnapshot(snapshot => { 
            if (snapshot.empty) { 
                container.innerHTML = `<p class="text-center text-text-secondary">No recent sell requests found.</p>`; 
                return; 
            } 
            container.innerHTML = ''; 
            snapshot.forEach(doc => { 
                const req = doc.data(); 
                const icon = req.type === 'niva-coin' ? 'toll' : 'mail'; 
                const title = req.type === 'niva-coin' ? `${(req.amount || 0).toLocaleString()} Niva Coin` : `${req.fileName}`; 
                const date = req.requestDate ? new Date(req.requestDate.seconds * 1000).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric'}) : 'N/A'; 
                
                let statusColor = 'orange';
                if (req.status === 'Completed') statusColor = 'green'; 
                if (req.status === 'Rejected') statusColor = 'red'; 
                
                container.insertAdjacentHTML('beforeend', 
                    `<div class="flex items-center gap-4 bg-card-background p-4 min-h-[72px] justify-between rounded-xl shadow-sm"><div class="flex items-center gap-4 min-w-0"><div class="text-white flex items-center justify-center rounded-lg bg-primary/20 shrink-0 w-12 h-12"><span class="material-symbols-outlined text-primary">${icon}</span></div><div class="flex flex-col justify-center min-w-0"><p class="text-white text-base font-medium truncate">${title}</p><p class="text-zinc-400 text-sm">${date}</p></div></div><div class="shrink-0"><div class="flex items-center justify-center rounded-full px-3 py-1 bg-${statusColor}-400/20 text-${statusColor}-400"><p class="text-xs font-semibold">${req.status}</p></div></div></div>`); 
            }); 
        }, err => console.error('History Load Error: ', err)); 
      }
      
      function loadDashboardData(userId) {
          db.collection('sellRequests').where('userId','==', userId).onSnapshot(snapshot => { 
              let nivaReqs = 0, nivaTotal = 0, gmailPending = 0; 
              snapshot.forEach(d => { const data = d.data(); if (data.type === 'niva-coin') { nivaReqs++; nivaTotal += Number(data.amount || 0); } if (data.type === 'gmail-id' && data.status === 'Processing') gmailPending++; }); 
              $('dashboard-niva-requests').textContent = `${nivaReqs} Requests`; 
              $('dashboard-niva-total').textContent = `${nivaTotal.toLocaleString()} Coins Total`; 
              $('dashboard-gmail-pending').textContent = `${gmailPending} IDs Pending`; 
          }, err => console.error('Dashboard data error:', err)); 
      }

      function loadProfileData(userId) {
          $('profile-id').textContent = `Telegram ID: ${userId}`; 
          db.collection('sellRequests').where('userId','==', userId).onSnapshot(snapshot => { 
              let coinsSold = 0, gmailSold = 0; 
              snapshot.forEach(d => { const data = d.data(); if (data.status === 'Completed') { if (data.type === 'niva-coin') coinsSold += Number(data.amount || 0); if (data.type === 'gmail-id') gmailSold += (data.count || 1); } }); 
              $('profile-coins-sold').textContent = coinsSold.toLocaleString(); 
              $('profile-gmail-sold').textContent = gmailSold.toLocaleString(); 
          }); 
      }
      
      function attachFormEventListeners(userId, userName) {
        const createPayload = (paymentMethod, paymentNumber) => ({
            userId: userId, // Telegram User ID
            userName: userName, // Telegram User Name
            status: 'Processing',
            requestDate: firebase.firestore.FieldValue.serverTimestamp(),
            paymentMethod,
            paymentNumber,
        });

        $('sell-niva-form').addEventListener('submit', async e => {
            e.preventDefault(); showLoader();
            try {
                const amount = parseFloat($('niva-amount-input').value); const file = $('niva-file-input').files[0]; const paymentMethod = document.querySelector('input[name="paymentMethodNiva"]:checked').value; const paymentNumber = $('niva-payment-number').value;
                if (!file) throw new Error("Please upload a screenshot.");
                
                // Use Telegram User ID in file path
                const filePath = `niva_proofs/${userId}/${Date.now()}-${file.name}`;
                const uploadTask = await storage.ref(filePath).put(file);
                const downloadURL = await uploadTask.ref.getDownloadURL();
                
                await db.collection('sellRequests').add({ ...createPayload(paymentMethod, paymentNumber), type: 'niva-coin', amount, proofImageUrl: downloadURL, });
                
                alert('Sell request submitted successfully!'); e.target.reset(); $('remove-niva-image-btn').click(); showPage('page-history', userId);
            } catch (err) {
                console.error("Niva Submit Error: ", err);
                alert(`Failed to submit request. Error: ${err.message}`);
            } finally {
                hideLoader();
            }
        });

        $('sell-gmail-form').addEventListener('submit', async e => {
            e.preventDefault(); showLoader();
            try {
                const file = $('gmail-file-input').files[0]; const paymentMethod = document.querySelector('input[name="paymentMethodGmail"]:checked').value; const paymentNumber = $('gmail-payment-number').value;
                if (!file) throw new Error("Please upload a file.");

                // Use Telegram User ID in file path
                const filePath = `gmail_files/${userId}/${Date.now()}-${file.name}`;
                const uploadTask = await storage.ref(filePath).put(file);
                const downloadURL = await uploadTask.ref.getDownloadURL();
                
                await db.collection('sellRequests').add({ ...createPayload(paymentMethod, paymentNumber), type: 'gmail-id', fileUrl: downloadURL, fileName: file.name, fileSize: file.size, });
                
                alert('Gmail file submitted successfully!'); e.target.reset(); $('remove-gmail-file-btn').click(); showPage('page-history', userId);
            } catch (err) {
                console.error("Gmail Submit Error: ", err);
                alert(`Failed to submit Gmail file. Error: ${err.message}`);
            } finally {
                hideLoader();
            }
        });
        
        $('goto-sell-niva-btn').addEventListener('click', () => showPage('page-sell-niva', userId));
        $('goto-sell-gmail-btn').addEventListener('click', () => showPage('page-sell-gmail', userId));
        navButtons.forEach(btn => {
          if (btn.dataset.page) {
              btn.addEventListener('click', () => showPage(btn.dataset.page, userId));
          }
        });
      }

      // --- COMMON HELPER FUNCTIONS (UNCHANGED) ---
      let marketRates = { nivaRate: 7.5, gmailRate: 13 };
      const updateRateDisplays = () => { /* ... no changes ... */ };
      const listenForRateChanges = () => { /* ... no changes ... */ };
      const allPages = document.querySelectorAll('.page');
      const navButtons = document.querySelectorAll('.nav-btn');
      function showPage(pageId, userId) { 
        allPages.forEach(p => p.classList.remove('active')); 
        $(pageId)?.classList.add('active'); 
        if (pageId === 'page-history' && userId) loadHistoryData(userId);
        
        const targetButton = Array.from(navButtons).find(b => b.dataset.page === pageId);
        navButtons.forEach(b => { if (b.dataset.page) { b.classList.remove('text-primary'); b.classList.add('text-text-secondary'); } }); 
        if(targetButton) { targetButton.classList.add('text-primary'); targetButton.classList.remove('text-text-secondary'); }
        window.scrollTo({ top: 0, behavior: 'smooth' }); 
      }
      
      // --- EVENT LISTENERS FOR FILE INPUTS (UNCHANGED) ---
      $('niva-amount-input').addEventListener('input', (e) => { const amount = parseFloat(e.target.value) || 0; const rate = marketRates.nivaRate; $('niva-payout-text').textContent = `You will receive: ~৳${((amount / 1000) * rate).toFixed(2)}`; });
      const nivaFileInput=$('niva-file-input');nivaFileInput.addEventListener('change',e=>{const file=e.target.files[0];if(file&&file.type.startsWith('image/')){const reader=new FileReader();reader.onload=event=>{($('niva-image-preview').src=event.target.result),$('niva-upload-prompt').classList.add('hidden'),$('niva-preview-container').classList.remove('hidden')},reader.readAsDataURL(file)}});$('remove-niva-image-btn').addEventListener('click',()=>{nivaFileInput.value='',($('niva-image-preview').src='#'),$('niva-upload-prompt').classList.remove('hidden'),$('niva-preview-container').classList.add('hidden')});const gmailFileInput=$('gmail-file-input');gmailFileInput.addEventListener('change',e=>{const file=e.target.files[0];file&&($('gmail-file-name').textContent=file.name,$('gmail-file-size').textContent=`${(file.size/1024).toFixed(2)} KB`,$('gmail-file-display').classList.remove('hidden'),$('gmail-upload-prompt').classList.add('hidden'))});$('remove-gmail-file-btn').addEventListener('click',()=>{gmailFileInput.value='',($('gmail-file-display').classList.add('hidden')),$('gmail-upload-prompt').classList.remove('hidden')});

      // --- INITIALIZE THE APP ---
      startApp();
    });
  </script>
</body>
</html>
