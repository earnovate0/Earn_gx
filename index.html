<!doctype html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Niva Coin App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <style type="text/tailwindcss">
    body { font-family: 'Inter', sans-serif; } .page { display: none; } .page.active { display: block; } .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #00D27F; width: 40px; height: 40px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .loading-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:9999; } .hidden { display: none !important; } .payment-method-label { border: 2px solid #4A4A4A; transition: all 0.2s ease-in-out; } .payment-method-radio:checked + .payment-method-label { border-color: #00D27F; background-color: #00D27F20; }
  </style>
  <script id="tailwind-config">tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#00D27F", "background": "#000000", "card-background": "#1A1A1A", "text-primary": "#FFFFFF", "text-secondary": "#A0A0A0", }, fontFamily: { "display": ["Inter", "sans-serif"] } } } }</script>
</head>
<body class="bg-background font-display text-text-primary antialiased">

  <div id="loading-overlay" class="loading-overlay"><div class="loader"></div></div>
  <div id="error-container" class="hidden flex items-center justify-center min-h-screen p-4 text-center"><p>This app can only be used inside Telegram.</p></div>
  
  <div id="app-container" class="relative min-h-screen w-full flex-col hidden">
    <!-- Dashboard -->
    <main id="page-dashboard" class="page flex-1 pb-28">
      <div class="flex items-center p-4"><h2 class="text-xl font-bold flex-1 text-text-secondary">Dashboard</h2><div class="flex size-10 shrink-0 items-center justify-end"><img class="user-profile-pic object-cover rounded-full size-10 border-2 border-primary" src="logo19.jpg" alt="User Avatar"></div></div>
      <h1 id="welcome-message" class="text-3xl font-bold px-4 pb-4 pt-4">Welcome!</h1>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 py-2">
        <button id="goto-sell-niva-btn" data-page="page-sell-niva" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-primary text-background font-bold gap-2"><span class="material-symbols-outlined">toll</span><span>Sell Niva Coins</span></button>
        <button id="goto-sell-gmail-btn" data-page="page-sell-gmail" class="nav-btn-internal flex w-full items-center justify-center rounded-lg h-14 bg-primary text-background font-bold gap-2"><span class="material-symbols-outlined">mail</span><span>Sell Gmail IDs</span></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
        <div><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center"><span class="material-symbols-outlined text-primary text-lg">toll</span></div><p>Niva Coin Sales</p></div><div class="flex items-end justify-between"><div class="flex flex-col"><p id="dashboard-niva-requests" class="text-sm text-text-secondary">...</p><p id="dashboard-niva-total" class="text-sm text-text-secondary">...</p></div><button class="nav-btn-internal flex items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div></div></div>
        <div><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center"><span class="material-symbols-outlined text-primary text-lg">mail</span></div><p>Gmail ID Sales</p></div><div class="flex items-end justify-between"><p id="dashboard-gmail-pending" class="text-sm text-text-secondary">...</p><button class="nav-btn-internal flex items-center justify-center rounded-md h-8 px-3 bg-card-background text-primary border border-primary text-xs font-medium" data-page="page-history">View</button></div></div></div>
        <div class="col-span-1 md:col-span-2"><div class="flex flex-col rounded-lg bg-card-background p-4"><div class="flex justify-between mb-2"><p>Market Rates</p><p class="text-xs font-bold text-red-500">Live</p></div><div class="flex flex-col gap-1"><p class="text-sm">Niva Coin: <span id="dashboard-niva-rate" class="text-primary font-bold">...</span></p><p class="text-sm">Gmail ID: <span id="dashboard-gmail-rate" class="text-primary font-bold">...</span></p></div></div></div>
      </div>
      <a href="https://t.me/earno_vate_earn" target="_blank" class="fixed bottom-24 right-4 z-50 flex h-14 w-14 items-center justify-center rounded-full bg-blue-600 text-white shadow-lg"><svg class="h-7 w-7" fill="currentColor" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-1.37.2-1.64l16.43-6.2c.75-.28 1.45.27 1.23 1.22l-2.67 12.3c-.22.99-1.21 1.22-1.87.73l-4.11-3.4-1.98 1.9z"></path></svg></a>
    </main>
    <main id="page-sell-niva" class="page flex-grow p-4 pb-28">
      <header class="flex items-center py-2 justify-between"><button class="nav-btn-internal text-white flex size-10 items-center justify-center -ml-2" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h1 class="text-lg font-bold flex-1 text-center">Sell Your Niva Coin</h1><div class="size-8"></div></header>
      <div class="rounded-xl bg-card-background my-4 p-4"><p class="text-lg font-bold">Current Rate: <span id="sell-niva-rate" class="text-primary">...</span></p></div>
      <form id="sell-niva-form" class="space-y-6">
          <div><label class="block mb-2">Amount to Sell</label><div class="relative"><input id="niva-amount-input" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4 pr-16" placeholder="e.g., 1000" type="number" step="any"/><span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">NIVA</span></div><p id="niva-payout-text" class="text-slate-300 pt-2">You will receive: ~৳0.00</p></div>
          <div><h2 class="text-lg font-bold mb-2">Proof of Transfer</h2><p class="text-sm text-slate-400 mb-4">Upload a screenshot of the completed transaction.</p><div class="relative w-full min-h-[160px] p-6 border-2 border-dashed border-slate-700 rounded-xl bg-card-background"><div id="niva-upload-prompt" class="flex flex-col items-center justify-center text-center cursor-pointer"><span class="material-symbols-outlined text-4xl text-slate-400 mb-2">upload_file</span><p>Attach Screenshot</p></div><div id="niva-preview-container" class="hidden absolute inset-2"><img id="niva-image-preview" src="#" alt="Preview" class="w-full h-full rounded-lg object-cover"><button id="remove-niva-image-btn" type="button" class="absolute top-2 right-2 text-white bg-black/50 flex size-8 items-center justify-center rounded-full"><span class="material-symbols-outlined text-xl">close</span></button></div><input id="niva-file-input" required class="absolute inset-0 opacity-0 cursor-pointer" type="file" accept="image/*"/></div></div>
          <div><h2 class="text-lg font-bold mb-3">Payment Details</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><input type="radio" id="niva-bkash" name="paymentMethodNiva" value="Bkash" class="hidden payment-method-radio" required checked><label for="niva-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./bkash.jpg" class="h-6" alt="Bkash"><span class="font-semibold">Bkash</span></label></div><div><input type="radio" id="niva-nagad" name="paymentMethodNiva" value="Nagad" class="hidden payment-method-radio" required><label for="niva-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./nagad.jpg" class="h-6" alt="Nagad"><span class="font-semibold">Nagad</span></label></div></div><label class="block"><span class="mb-2 block">Payment Number</span><input id="niva-payment-number" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4" placeholder="01XXXXXXXXX" type="tel" pattern="01[0-9]{9}" maxlength="11"/></label></div>
          <button type="submit" class="w-full bg-primary text-background font-bold py-3.5 px-6 rounded-lg !mt-8">Submit Sell Order</button>
      </form>
    </main>
    <main id="page-sell-gmail" class="page flex-grow p-4 pb-28">
      <header class="flex items-center py-2 justify-between"><button class="nav-btn-internal text-white flex size-10 items-center justify-center -ml-2" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl">arrow_back</span></button><h2 class="text-lg font-bold flex-1 text-center">Sell Gmail IDs</h2><div class="size-8"></div></header>
      <form id="sell-gmail-form" class="flex flex-col flex-grow space-y-6 mt-4">
          <div><p class="text-gray-300 mb-3">Upload your .xlsx or .csv file.</p><div class="relative flex flex-col items-center justify-center gap-6 rounded-xl border-2 border-dashed border-gray-700 px-6 py-10 cursor-pointer"><div id="gmail-upload-prompt"><span class="material-symbols-outlined text-5xl text-gray-400 mx-auto">cloud_upload</span><p class="font-bold text-center">Tap to select a file</p></div><input id="gmail-file-input" required type="file" accept=".xlsx,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" class="absolute inset-0 opacity-0 cursor-pointer"/></div><div id="gmail-file-display" class="hidden items-center gap-4 rounded-xl border border-gray-700 bg-card-background p-4 mt-4"><div class="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/20 text-primary shrink-0"><span class="material-symbols-outlined text-2xl">description</span></div><div class="flex-1 min-w-0"><p id="gmail-file-name" class="font-medium break-words"></p><p id="gmail-file-size" class="text-sm text-gray-400"></p></div><button id="remove-gmail-file-btn" type="button" class="text-gray-400 flex size-10 items-center justify-center rounded-full shrink-0"><span class="material-symbols-outlined text-2xl">close</span></button></div></div>
          <div><h2 class="text-lg font-bold mb-3">Payment Details</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><input type="radio" id="gmail-bkash" name="paymentMethodGmail" value="Bkash" class="hidden payment-method-radio" required checked><label for="gmail-bkash" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./bkash.jpg" class="h-6" alt="Bkash"><span>Bkash</span></label></div><div><input type="radio" id="gmail-nagad" name="paymentMethodGmail" value="Nagad" class="hidden payment-method-radio" required><label for="gmail-nagad" class="payment-method-label flex items-center justify-center gap-2 p-3 rounded-lg cursor-pointer"><img src="./nagad.jpg" class="h-6" alt="Nagad"><span>Nagad</span></label></div></div><label><span class="mb-2 block">Payment Number</span><input id="gmail-payment-number" required class="form-input w-full rounded-lg text-white border-slate-700 bg-card-background h-14 p-4" placeholder="01XXXXXXXXX" type="tel" pattern="01[0-9]{9}" maxlength="11"/></label></div>
          <div class="flex-grow"></div><div class="pt-4"><button type="submit" class="w-full h-12 bg-primary text-background font-bold rounded-xl">Submit Request</button></div>
      </form>
    </main>
    <main id="page-history" class="page flex-1 pb-28"><header class="py-4 px-4"><h1 class="text-lg font-bold text-center">My Sell Requests</h1></header><div id="history-list-container" class="px-4 pt-2 space-y-3"><div class="text-center text-text-secondary">Loading history...</div></div></main>
    <main id="page-profile" class="page flex-1 p-4 pb-28">
      <h1 class="text-lg font-bold text-center mb-6">Settings</h1>
      <div class="flex flex-col gap-8">
        <section class="flex w-full items-center gap-4 rounded-xl bg-card-background p-4"><div class="shrink-0"><img class="user-profile-pic object-cover rounded-full h-16 w-16 border-2 border-primary" src="logo19.jpg" alt="User Avatar"></div><div class="min-w-0"><p id="profile-name" class="text-lg font-bold truncate">...</p><p id="profile-id" class="text-sm text-text-secondary break-all">...</p></div></section>
        <section><h2 class="px-2 mb-3 text-sm font-semibold uppercase text-text-secondary">Activity Summary</h2><div class="grid grid-cols-2 gap-4"><div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4"><span class="material-symbols-outlined text-primary text-3xl">toll</span><p class="text-xs text-text-secondary">Total Coins Sold</p><p id="profile-coins-sold" class="text-xl font-bold">0</p></div><div class="flex flex-col gap-2 rounded-xl bg-primary/10 p-4"><span class="material-symbols-outlined text-primary text-3xl">alternate_email</span><p class="text-xs text-text-secondary">Total Gmail IDs Sold</p><p id="profile-gmail-sold" class="text-xl font-bold">0</p></div></div></section>
        
        <!-- Admin Panel Section -->
        <section id="admin-panel" class="hidden">
          <h2 class="px-2 mb-3 text-sm font-semibold uppercase text-text-secondary">Admin Panel</h2>
          <div class="bg-card-background rounded-xl p-4 space-y-4">
            <h3 class="font-bold">Update Rates</h3>
            <form id="update-rates-form" class="space-y-3">
              <div>
                <label for="admin-niva-rate" class="block text-sm mb-1">Niva Coin Rate (/k)</label>
                <input id="admin-niva-rate" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required>
              </div>
              <div>
                <label for="admin-gmail-rate" class="block text-sm mb-1">Gmail ID Rate</label>
                <input id="admin-gmail-rate" type="number" step="0.01" class="form-input w-full rounded-lg text-white border-slate-700 bg-background h-12 p-3" required>
              </div>
              <button type="submit" class="w-full bg-primary text-background font-bold py-2.5 px-4 rounded-lg">Update Rates</button>
            </form>
          </div>

          <div class="mt-6">
            <h3 class="font-bold mb-3 px-2">All Sell Requests</h3>
            <div id="admin-requests-container" class="space-y-3">
              <p class="text-center text-text-secondary">Loading requests...</p>
            </div>
          </div>
        </section>

        <section class="flex w-full items-center justify-between gap-4 rounded-xl bg-blue-900/50 p-4 border border-blue-700"><div class="flex items-center gap-4"><div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-blue-500 text-white"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-1.37.2-1.64l16.43-6.2c.75-.28 1.45.27 1.23 1.22l-2.67 12.3c-.22.99-1.21 1.22-1.87.73l-4.11-3.4-1.98 1.9z"></path></svg></div><div><p class="font-bold text-white">Join Our Telegram</p><p class="text-sm text-blue-200">For news & updates</p></div></div><a href="https://t.me/earno_vate_earn" target="_blank" class="flex h-10 shrink-0 items-center justify-center rounded-lg bg-blue-600 px-4 text-sm font-bold text-white">Join</a></section>
        <div class="bg-blue-900/50 border border-blue-700 text-blue-300 text-sm rounded-lg p-3 text-center">সেল করার পূর্বে টেলিগ্রামের বিস্তারিত দেখে নিবেন</div>
      </div>
    </main>
    <div class="fixed bottom-0 left-0 right-0 h-20 bg-card-background/90 backdrop-blur-sm border-t border-text-secondary/10">
      <div class="grid h-full max-w-lg grid-cols-4 mx-auto">
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-primary" data-page="page-dashboard"><span class="material-symbols-outlined text-2xl mb-1">dashboard</span><span class="text-xs">Dashboard</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-text-secondary" data-page="page-sell-niva"><span class="material-symbols-outlined text-2xl mb-1">add_circle</span><span class="text-xs">Sell</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-text-secondary" data-page="page-history"><span class="material-symbols-outlined text-2xl mb-1">history</span><span class="text-xs">History</span></button>
        <button class="nav-btn inline-flex flex-col items-center justify-center px-5 text-text-secondary" data-page="page-profile"><span class="material-symbols-outlined text-2xl mb-1">person</span><span class="text-xs">Profile</span></button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = {
        apiKey: "AIzaSyCAQtTRKgOizQjgqCbIZ_Z357LQD2Woee8",
        authDomain: "earnovate-bot.firebaseapp.com",
        databaseURL: "https://earnovate-bot-default-rtdb.firebaseio.com",
        projectId: "earnovate-bot",
        storageBucket: "earnovate-bot.appspot.com",
        messagingSenderId: "395184310691",
        appId: "1:395184310691:web:9a0a2e5ad0e954b527b216",
        measurementId: "G-S6G9YSP2HN"
      };
      
      const ADMIN_TELEGRAM_ID = '6703675335';
      const $ = (id) => document.getElementById(id);
      const showLoader = () => $('loading-overlay').classList.remove('hidden');
      const hideLoader = () => $('loading-overlay').classList.add('hidden');
      let db, storage, telegramUser, auth;
      let marketRates = { nivaRate: 7.5, gmailRate: 13 };

      function startApp() {
        try {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          db = firebase.firestore();
          storage = firebase.storage();
          auth = firebase.auth();
          
          if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
            const tg = window.Telegram.WebApp;
            tg.ready(); tg.expand();
            telegramUser = tg.initDataUnsafe?.user;
            if (telegramUser?.id) {
              auth.signInAnonymously().then(() => {
                initializeAppUI();
              }).catch(err => {
                throw new Error("Firebase anonymous sign-in failed: " + err.message);
              });
            } else {
              throw new Error("Could not get Telegram user data.");
            }
          } else {
            $('error-container').classList.remove('hidden');
            hideLoader();
          }
        } catch (error) {
          console.error("App failed to start:", error);
          alert("Could not start the app. Please try again.");
          hideLoader();
        }
      }
      
      function initializeAppUI() {
        const { id, first_name, photo_url } = telegramUser;
        document.querySelectorAll('.user-profile-pic').forEach(p => p.src = photo_url || 'logo19.jpg');
        $('welcome-message').textContent = `Welcome, ${first_name || 'User'}!`;
        $('profile-name').textContent = first_name || 'User';
        $('profile-id').textContent = `Telegram ID: ${id}`;
        
        if (id.toString() === ADMIN_TELEGRAM_ID) {
            $('admin-panel').classList.remove('hidden');
            loadAdminData();
        }
        
        $('app-container').classList.remove('hidden');
        setupEventListeners();
        showPage('page-dashboard');
        listenForRateChanges();
        loadDashboardData(); 
        loadProfileData(); 
        hideLoader();
      }

      function setupEventListeners() {
        const { id: userId, first_name: userName, photo_url: photoUrl } = telegramUser;
        const createPayload = (pm, pn) => ({ 
            userId: auth.currentUser.uid,
            telegramId: userId.toString(), 
            userName, 
            userPhotoUrl: photoUrl || null, 
            status: 'Processing', 
            requestDate: firebase.firestore.FieldValue.serverTimestamp(), 
            paymentMethod: pm, 
            paymentNumber: pn 
        });

        document.querySelectorAll('.nav-btn, .nav-btn-internal').forEach(btn => { btn.addEventListener('click', () => showPage(btn.dataset.page)); });
        
        const nivaFileInput = $('niva-file-input');
        $('niva-amount-input').addEventListener('input', () => { const amount = parseFloat($('niva-amount-input').value) || 0; $('niva-payout-text').textContent = `You will receive: ~৳${(amount / 1000 * marketRates.nivaRate).toFixed(2)}`; });
        nivaFileInput.addEventListener('change', () => { const file = nivaFileInput.files[0]; if (file) { $('niva-image-preview').src = URL.createObjectURL(file); $('niva-upload-prompt').classList.add('hidden'); $('niva-preview-container').classList.remove('hidden'); } });
        $('remove-niva-image-btn').addEventListener('click', (e) => { e.preventDefault(); nivaFileInput.value = null; $('niva-image-preview').src = '#'; $('niva-upload-prompt').classList.remove('hidden'); $('niva-preview-container').classList.add('hidden'); });
        $('sell-niva-form').addEventListener('submit', async (e) => { e.preventDefault(); showLoader(); try { const file = nivaFileInput.files[0]; if (!file) throw new Error("Please upload a screenshot."); const filePath = `niva_proofs/${userId}/${Date.now()}-${file.name}`; const downloadURL = await (await storage.ref(filePath).put(file)).ref.getDownloadURL(); const payload = createPayload($('sell-niva-form').paymentMethodNiva.value, $('niva-payment-number').value); payload.type = 'niva-coin'; payload.amount = parseFloat($('niva-amount-input').value); payload.proofImageUrl = downloadURL; await db.collection('sellRequests').add(payload); alert('Request submitted successfully!'); e.target.reset(); $('remove-niva-image-btn').click(); showPage('page-history'); } catch (err) { alert(`Submission Failed: ${err.message}`); console.error(err); } finally { hideLoader(); } });
        
        const gmailFileInput = $('gmail-file-input');
        gmailFileInput.addEventListener('change', () => { const file = gmailFileInput.files[0]; if (file) { $('gmail-file-name').textContent = file.name; $('gmail-file-size').textContent = `${(file.size/1024).toFixed(2)} KB`; $('gmail-upload-prompt').classList.add('hidden'); $('gmail-file-display').classList.remove('hidden'); } });
        $('remove-gmail-file-btn').addEventListener('click', (e) => { e.preventDefault(); gmailFileInput.value = null; $('gmail-upload-prompt').classList.remove('hidden'); $('gmail-file-display').classList.add('hidden'); });
        $('sell-gmail-form').addEventListener('submit', async (e) => { e.preventDefault(); showLoader(); try { const file = gmailFileInput.files[0]; if (!file) throw new Error("Please upload a file."); const filePath = `gmail_files/${userId}/${Date.now()}-${file.name}`; const downloadURL = await (await storage.ref(filePath).put(file)).ref.getDownloadURL(); const payload = createPayload($('sell-gmail-form').paymentMethodGmail.value, $('gmail-payment-number').value); payload.type = 'gmail-id'; payload.fileUrl = downloadURL; payload.fileName = file.name; payload.fileSize = file.size; await db.collection('sellRequests').add(payload); alert('Request submitted successfully!'); e.target.reset(); $('remove-gmail-file-btn').click(); showPage('page-history'); } catch (err) { alert(`Submission Failed: ${err.message}`); console.error(err); } finally { hideLoader(); } });

        if (telegramUser.id.toString() === ADMIN_TELEGRAM_ID) {
            $('update-rates-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader();
                try {
                    const nivaRate = parseFloat($('admin-niva-rate').value);
                    const gmailRate = parseFloat($('admin-gmail-rate').value);
                    if (isNaN(nivaRate) || isNaN(gmailRate)) {
                        throw new Error("Invalid rate values.");
                    }
                    await db.collection('settings').doc('rates').set({ nivaRate, gmailRate });
                    alert('Rates updated successfully!');
                } catch (err) {
                    alert(`Rate update failed: ${err.message}`);
                    console.error(err);
                } finally {
                    hideLoader();
                }
            });
        }
      }
      
      function showPage(pageId) {
        if (pageId) {
          document.querySelectorAll(".page").forEach(page => page.classList.remove("active"));
          $(pageId)?.classList.add("active");
          if (pageId === "page-history") loadHistoryData();
          if (pageId === "page-profile" && telegramUser.id.toString() === ADMIN_TELEGRAM_ID) loadAdminData();

          document.querySelectorAll(".nav-btn").forEach(btn => {
            btn.classList.toggle("text-primary", btn.dataset.page === pageId);
            btn.classList.toggle("text-text-secondary", btn.dataset.page !== pageId);
          });
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      }

      function listenForRateChanges() {
        db.collection("settings").doc("rates").onSnapshot(doc => {
          marketRates = { nivaRate: doc.data()?.nivaRate || 7.5, gmailRate: doc.data()?.gmailRate || 13 };
          const nivaRateText = `৳${marketRates.nivaRate} /k`;
          const gmailRateText = `৳${marketRates.gmailRate}`;
          $("dashboard-niva-rate").textContent = nivaRateText;
          $("dashboard-gmail-rate").textContent = gmailRateText;
          $("sell-niva-rate").textContent = nivaRateText;
          
          if (telegramUser.id.toString() === ADMIN_TELEGRAM_ID) {
            $("admin-niva-rate").value = marketRates.nivaRate;
            $("admin-gmail-rate").value = marketRates.gmailRate;
          }

        }, (error) => {
          console.error("Error listening for rate changes:", error);
        });
      }
      
      function loadHistoryData() {
        const container = $("history-list-container");
        db.collection("sellRequests")
          .where("telegramId", "==", telegramUser.id.toString())
          .orderBy("requestDate", "desc")
          .onSnapshot(snapshot => {
            container.innerHTML = snapshot.empty ? '<p class="text-center text-text-secondary">No requests found.</p>' : "";
            snapshot.forEach(doc => {
              const data = doc.data();
              const icon = data.type === "niva-coin" ? "toll" : "mail";
              const title = data.type === "niva-coin" ? `${(data.amount || 0).toLocaleString()} Coin` : `${data.fileName}`;
              const date = data.requestDate ? new Date(data.requestDate.seconds * 1000).toLocaleDateString("en-GB") : "N/A";
              let statusColor = data.status === "Completed" ? "green" : data.status === "Rejected" ? "red" : "orange";
              container.insertAdjacentHTML("beforeend", `
                <div class="flex items-center gap-4 bg-card-background p-3 rounded-xl">
                  <div class="flex items-center justify-center rounded-lg bg-primary/20 shrink-0 w-12 h-12"><span class="material-symbols-outlined text-primary">${icon}</span></div>
                  <div class="flex-1 min-w-0"><p class="font-medium truncate">${title}</p><p class="text-zinc-400 text-sm">${date}</p></div>
                  <div class="shrink-0"><div class="rounded-full px-3 py-1 bg-${statusColor}-400/20 text-${statusColor}-400"><p class="text-xs font-semibold">${data.status}</p></div></div>
                </div>`);
            });
          }, (error) => {
            container.innerHTML = '<p class="text-center text-red-400">Could not load history.</p>';
            console.error("Error loading history:", error);
          });
      }

      function loadDashboardData() {
        db.collection("sellRequests")
          .where("telegramId", "==", telegramUser.id.toString())
          .onSnapshot(snapshot => {
            let nivaRequests = 0, nivaTotal = 0, gmailPending = 0;
            snapshot.forEach(doc => {
              const data = doc.data();
              if (data.type === "niva-coin") {
                nivaRequests++;
                nivaTotal += Number(data.amount || 0);
              } else if (data.type === "gmail-id" && data.status === "Processing") {
                gmailPending++;
              }
            });
            $("dashboard-niva-requests").textContent = `${nivaRequests} Requests`;
            $("dashboard-niva-total").textContent = `${nivaTotal.toLocaleString()} Coins`;
            $("dashboard-gmail-pending").textContent = `${gmailPending} IDs Pending`;
          });
      }
      
      function loadProfileData() {
        db.collection("sellRequests")
          .where("telegramId", "==", telegramUser.id.toString())
          .onSnapshot(snapshot => {
            let coinsSold = 0, gmailSold = 0;
            snapshot.forEach(doc => {
              const data = doc.data();
              if (data.status === "Completed") {
                if (data.type === "niva-coin") {
                  coinsSold += Number(data.amount || 0);
                } else if (data.type === "gmail-id") {
                  gmailSold += (data.count || 1); 
                }
              }
            });
            $("profile-coins-sold").textContent = coinsSold.toLocaleString();
            $("profile-gmail-sold").textContent = gmailSold.toLocaleString();
          });
      }

      function loadAdminData() {
          const container = $('admin-requests-container');
          db.collection('sellRequests').orderBy('requestDate', 'desc').onSnapshot(snapshot => {
              container.innerHTML = snapshot.empty ? '<p class="text-center text-text-secondary">No requests found.</p>' : '';
              snapshot.forEach(doc => {
                  const request = doc.data();
                  const requestId = doc.id;
                  const date = request.requestDate ? new Date(request.requestDate.seconds * 1000).toLocaleString('en-GB') : 'N/A';
                  const details = request.type === 'niva-coin' 
                      ? `<b>Amount:</b> ${request.amount} Niva<br><a href="${request.proofImageUrl}" target="_blank" class="text-primary">View Proof</a>`
                      : `<b>File:</b> <a href="${request.fileUrl}" target="_blank" class="text-primary">${request.fileName}</a>`;

                  container.insertAdjacentHTML('beforeend', `
                      <div class="bg-background p-3 rounded-lg border border-slate-800">
                          <p class="text-xs text-text-secondary">${date}</p>
                          <p class="font-bold">${request.userName} (${request.telegramId})</p>
                          <p class="text-sm my-2">${details}</p>
                          <p class="text-sm"><b>Payment:</b> ${request.paymentMethod} - ${request.paymentNumber}</p>
                          <p class="text-sm"><b>Status:</b> ${request.status}</p>
                          ${request.status === 'Processing' ? `
                          <div class="flex gap-2 mt-3">
                              <button class="approve-btn flex-1 bg-green-500/20 text-green-400 text-sm font-bold py-1.5 rounded" data-id="${requestId}">Approve</button>
                              <button class="reject-btn flex-1 bg-red-500/20 text-red-400 text-sm font-bold py-1.5 rounded" data-id="${requestId}">Reject</button>
                          </div>` : ''}
                      </div>
                  `);
              });

              document.querySelectorAll('.approve-btn').forEach(btn => btn.onclick = () => updateRequestStatus(btn.dataset.id, 'Completed'));
              document.querySelectorAll('.reject-btn').forEach(btn => btn.onclick = () => updateRequestStatus(btn.dataset.id, 'Rejected'));

          }, (error) => {
              container.innerHTML = '<p class="text-center text-red-400">Could not load requests.</p>';
              console.error("Error loading admin requests:", error);
          });
      }

      async function updateRequestStatus(id, status) {
          showLoader();
          try {
              await db.collection('sellRequests').doc(id).update({ status: status });
              alert(`Request has been ${status.toLowerCase()}.`);
          } catch (err) {
              alert(`Failed to update status: ${err.message}`);
              console.error(err);
          } finally {
              hideLoader();
          }
      }

      startApp();
    });
  </script>
</body>
</html>
